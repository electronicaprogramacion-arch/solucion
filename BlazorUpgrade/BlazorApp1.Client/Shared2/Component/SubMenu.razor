@using Blazed.Controls
@using Blazored.Modal
@using Blazored.Modal.Services
@using BrowserInterop.Extensions;
@using System.Timers;
@using CalibrationSaaS.Application.Services
@using CalibrationSaaS.Domain.Aggregates.Entities
@using CalibrationSaaS.Domain.Aggregates.ValueObjects;


@using CalibrationSaaS.Infraestructure.Blazor.Services
@using Helpers
@using Microsoft.Extensions.Logging
@using ProtoBuf.Grpc;
@using Grpc.Core;
@using System.Reflection;
@using System.Collections.Generic;
@using System.Linq;
@using Microsoft.Extensions.Options
@using Helpers.Controls;
@using Helpers.Controls.ValueObjects;
@using Blazed.Controls.Toast;
@using Radzen
@using Radzen.Blazor
@using Microsoft.AspNetCore.Components.Web

@inherits CalibrationSaaS.Infraestructure.Blazor.FComponentBase
@inject Microsoft.Extensions.Configuration.IConfiguration config;
@inject CalibrationSaaS.Domain.Aggregates.Shared.AppSecurity AppSecurity
@inject NavigationManager NavigationManager

<div class="submenu-container @(IsCollapsed ? "collapsed" : "")" style="width:100%">
    <div class="submenu-content">
        <div class="navigation-buttons">
            <Blazed.Controls.BackComponent>
            </Blazed.Controls.BackComponent>
        </div>

        <div class="context-buttons">
            <Blazed.Controls.SearchComponent>

            </Blazed.Controls.SearchComponent>

            @if (ContextButtons != null)
            {
                @ContextButtons
            }
            else if (PageButtons != null)
            {
                @PageButtons
            }
            else
            {
                @* @GetDefaultButtons() *@
            }
        </div>

        @* <div class="pin-button">
            <RadzenButton Icon="@(IsPinned ? "push_pin" : "push_pin_outlined")"
                          ButtonStyle="ButtonStyle.Secondary"
                          Click="TogglePin"
                          Title="@(IsPinned ? "Unpin submenu" : "Pin submenu")" />
        </div> *@
    </div>
</div>

@if (IsCollapsed)
{
    @* <div class="pin-button">
        <RadzenButton Icon="keyboard_arrow_down"
                      ButtonStyle="ButtonStyle.Secondary"
                      Click="ToggleCollapse"
                      Size="ButtonSize.Small"
                      Title="Show submenu" />
    </div> *@
}

@code {
    [Parameter] public RenderFragment ContextButtons { get; set; }
    [Parameter] public RenderFragment PageButtons { get; set; }
    [Parameter] public EventCallback NavigateBackClick { get; set; }
    [Parameter] public EventCallback NavigateForwardClick { get; set; }
    [Parameter] public EventCallback<bool> PinnedChanged { get; set; }

    private bool IsPinned { get; set; } = true;
    private bool IsCollapsed => !IsPinned;

    private async Task NavigateBack()
    {
        await NavigateBackClick.InvokeAsync();
    }

    private async Task NavigateForward()
    {
        await NavigateForwardClick.InvokeAsync();
    }

    private async Task TogglePin()
    {
        IsPinned = !IsPinned;
        await PinnedChanged.InvokeAsync(IsPinned);
    }

    private void ToggleCollapse()
    {
        IsPinned = true;
    }

    private RenderFragment GetDefaultButtons()
    {
        // Get the current route
        var currentRoute = NavigationManager.Uri.Replace(NavigationManager.BaseUri, "").Split('?')[0];

        // Return different buttons based on the route
        return (builder) =>
        {
            if (currentRoute == "" || currentRoute == "/")
            {
                builder.OpenElement(0, "div");
                builder.AddAttribute(1, "class", "default-buttons");

                builder.OpenComponent<RadzenButton>(2);
                builder.AddAttribute(3, "Text", "New Customer");
                builder.AddAttribute(4, "Icon", "person_add");
                builder.AddAttribute(5, "ButtonStyle", ButtonStyle.Primary);
                builder.AddAttribute(6, "Click", EventCallback.Factory.Create<MouseEventArgs>(this, () => NavigationManager.NavigateTo("/customers/new")));
                builder.AddAttribute(7, "class", "rz-mr-2 action-button");
                builder.CloseComponent();

                builder.OpenComponent<RadzenButton>(8);
                builder.AddAttribute(9, "Text", "New Asset");
                builder.AddAttribute(10, "Icon", "inventory");
                builder.AddAttribute(11, "ButtonStyle", ButtonStyle.Primary);
                builder.AddAttribute(12, "Click", EventCallback.Factory.Create<MouseEventArgs>(this, () => NavigationManager.NavigateTo("/assets/new")));
                builder.AddAttribute(13, "class", "rz-mr-2 action-button");
                builder.CloseComponent();

                builder.OpenComponent<RadzenButton>(14);
                builder.AddAttribute(15, "Text", "New Order");
                builder.AddAttribute(16, "Icon", "shopping_cart");
                builder.AddAttribute(17, "ButtonStyle", ButtonStyle.Primary);
                builder.AddAttribute(18, "Click", EventCallback.Factory.Create<MouseEventArgs>(this, () => NavigationManager.NavigateTo("/orders/new")));
                builder.AddAttribute(19, "class", "action-button");
                builder.CloseComponent();

                builder.CloseElement();
            }
            else if (currentRoute.StartsWith("customers"))
            {
                builder.OpenElement(0, "div");
                builder.AddAttribute(1, "class", "default-buttons");

                builder.OpenComponent<RadzenButton>(2);
                builder.AddAttribute(3, "Text", "New Customer");
                builder.AddAttribute(4, "Icon", "person_add");
                builder.AddAttribute(5, "ButtonStyle", ButtonStyle.Primary);
                builder.AddAttribute(6, "Click", EventCallback.Factory.Create<MouseEventArgs>(this, () => NavigationManager.NavigateTo("/customers/new")));
                builder.AddAttribute(7, "class", "action-button");
                builder.CloseComponent();

                builder.CloseElement();
            }
            // Add more route-specific buttons as needed
        };
    }
}

<style>
    .submenu-container {
        padding: 0.5rem 1.5rem;
        height: 60px;
        display: flex;
        align-items: center;
        transition: height 0.3s ease, opacity 0.3s ease, transform 0.3s ease;
    }

        .submenu-container.collapsed {
            height: 0;
            opacity: 0;
            transform: translateY(-10px);
            overflow: hidden;
            padding: 0 1.5rem;
        }

    .submenu-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        height: 46px;
       /*  background-color: var(--rz-secondary);
        color: var(--rz-text-contrast-color); */
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        padding: 0 1rem;
        overflow-x: auto;
    }

    .navigation-buttons {
        display: flex;
        align-items: center;
        min-width: 90px;
        flex-shrink: 0;
    }

    .context-buttons {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-grow: 1;
        overflow-x: auto;
        padding: 0 0.5rem;
    }

    .pin-button {
        min-width: 40px;
        display: flex;
        justify-content: flex-end;
        flex-shrink: 0;
    }

    .default-buttons {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        justify-content: center;
    }

    .submenu-toggle-button {
        position: fixed;
        top: 56px; /* Adjust this value to match your header height */
        right: 20px;
        z-index: 100;
    }

    /* :root[data-theme="dark"] .submenu-content {
        background-color: var(--rz-secondary);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    } */

    /* Responsive styles */
    @@media (max-width: 768px) {
        .submenu-container {
            padding: 0.5rem 0.5rem;
            height: auto;
        }

        .submenu-content {
            height: auto;
            flex-wrap: wrap;
            padding: 0.5rem;
        }

        .navigation-buttons {
            order: 1;
            margin-bottom: 0.5rem;
            width: auto;
        }

        .context-buttons {
            order: 3;
            flex-basis: 100%;
            justify-content: center;
            margin-top: 0.5rem;
        }

        .pin-button {
            order: 2;
            margin-left: auto;
        }

        .default-buttons {
            flex-direction: column;
            align-items: stretch;
            width: 100%;
        }

            .default-buttons .action-button {
                margin-right: 0 !important;
                margin-bottom: 0.5rem;
                width: 100%;
                display: flex;
                justify-content: flex-start;
            }

                .default-buttons .action-button:last-child {
                    margin-bottom: 0;
                }

        .submenu-toggle-button {
            top: 50px;
            right: 10px;
        }

        .nav-button {
            padding: 0.3rem;
        }
    }

    @@media (max-width: 480px) {
        .submenu-container {
            padding: 0.3rem;
        }
    }
</style>



  @code{


    [Inject]
    public IBasicsServices<CallContext> basicServices { get; set; }
    [Inject]
    public IPieceOfEquipmentService<CallContext> poeServices { get; set; }
    [Inject]
    public IWorkOrderDetailServices<CallContext> wodServices { get; set; }
    [Inject]
    public ICustomerService<CallContext> CustomerServices { get; set; }
    [Inject]
    public IWorkOrderService<CallContext> woServices { get; set; }

    [Inject]
    public IAssetsServices<CallContext> assetsServices { get; set; }

    public async Task SearchFunction(string SearchTerm)
    {
        try
        {
            await ShowProgress();
            await ShowModalPoEIndicator(SearchTerm);

        }
        catch (Exception ex)
        {

        }

        finally
        {
            await CloseProgress();
        }

     }
    [CascadingParameter] public IModalService Modal { get; set; }

    public async Task ShowModalPoEIndicator(string SearchTerm)
    {
        Pagination<PieceOfEquipment> pag = new Pagination<PieceOfEquipment>();

        pag.Filter = SearchTerm;
        pag.Show = 5;
        pag.Top = 5;
        ResultSet<PieceOfEquipment> result0 = new ResultSet<PieceOfEquipment>();

        var _poeGrpc = new PieceOfEquipmentGRPC(poeServices);

        var g = new CallOptions();

        if (String.IsNullOrEmpty(SearchTerm))
        {
            await ShowToast("Please enter a keyword.", ToastLevel.Warning);
            return;
        }
        result0 = (await _poeGrpc.GetPiecesOfEquipmentXDueDate(pag, g));

        List<KeyValueSearch> lista = new List<KeyValueSearch>();

        if (result0.List != null)
        {
            foreach (var item in result0.List)
            {
                KeyValueSearch KeyValueSearch = new KeyValueSearch();

                KeyValueSearch.Type = "Piece Of Equipment";
                KeyValueSearch.Link = "PieceOfEquipmentCreate/" + item.PieceOfEquipmentID;
                KeyValueSearch.Fields = item.GetFields(SearchTerm);
                lista.Add(KeyValueSearch);
            }
        }



        //PieceOfEquipmentCreate
        Pagination<EquipmentTemplate> pag2 = new Pagination<EquipmentTemplate>();

        pag2.Filter = SearchTerm;
        pag2.Show = 5;
        pag2.Top = 5;


        ResultSet<EquipmentTemplate> result3 = new ResultSet<EquipmentTemplate>();

        var basic = new BasicsServiceGRPC(basicServices);

        //var g = new CallOptions();

        result3 = (await basic.GetEquipment(pag2, g));

        if (result3.List != null)
        {
            foreach (var item in result3.List)
            {
                KeyValueSearch KeyValueSearch = new KeyValueSearch();

                KeyValueSearch.Type = "Equipment Template";
                KeyValueSearch.Link = "EquipmentTemplate/" + item.EquipmentTemplateID;
                KeyValueSearch.Fields = item.GetFields(SearchTerm);
                lista.Add(KeyValueSearch);
            }
        }

        Pagination<WorkOrder> pag3 = new Pagination<WorkOrder>();

        pag3.Filter = SearchTerm;
        pag3.Show = 5;
        pag3.Top = 5;

        ResultSet<WorkOrder> result4 = new ResultSet<WorkOrder>();

        var wod = new AssetsServiceGRPC(assetsServices);

        //var g = new CallOptions();

        result4 = (await wod.GetWorkOrders(pag3, g));

        if (result4.List != null)
        {
            foreach (var item in result4.List)
            {
                KeyValueSearch KeyValueSearch = new KeyValueSearch();

                KeyValueSearch.Type = "Work Order";
                KeyValueSearch.Link = "WorkOrderCreate/" + item.WorkOrderId;
                KeyValueSearch.Fields = item.GetFields(SearchTerm);
                lista.Add(KeyValueSearch);
            }
        }



        Pagination<Customer> pag4 = new Pagination<Customer>();

        pag4.Filter = SearchTerm;
        pag4.Show = 5;
        pag4.Top = 5;

        ResultSet<Customer> result5 = new ResultSet<Customer>();

        var cust = new CustomerGRPC(CustomerServices);

        //var g = new CallOptions();

        result5 = (await cust.GetCustomers(pag4, g));

        if (result5.List != null)
        {
            foreach (var item in result5.List)
            {
                KeyValueSearch KeyValueSearch = new KeyValueSearch();

                KeyValueSearch.Type = "Customer";
                KeyValueSearch.Link = "Customer/" + item.CustomerID;
                KeyValueSearch.Fields = item.GetFields(SearchTerm);
                lista.Add(KeyValueSearch);
            }
        }



        var parameters = new ModalParameters();
        parameters.Add("SelectOnly", true);
        parameters.Add("IsModal", true);
        parameters.Add("Checkbox", false);
        parameters.Add("Indicator", true);
        parameters.Add("_pieceOfEquipmentsDueDate", lista);


        ModalOptions op = new ModalOptions();
        op.ContentScrollable = true;
        op.Class = "blazored-modal " + ModalSize.MediumWindow;
        //PieceOfEquipmentDueDate_Search
        var messageForm = Modal.Show<BlazorApp1.Blazor.Blazor.Pages.Full_Search>("Results for Keyword " + SearchTerm, parameters, op);
        var result = await messageForm.Result;
        Console.Write("result " + result);
        if (result != null && !result.Cancelled)
        {

            var res = (KeyValueSearch)result.Data;
            //PieceOfEquipment _poe = new PieceOfEquipment();
            //_poe.PieceOfEquipmentID = res.FirstOrDefault().PieceOfEquipmentID;

            NavigationManager.NavigateTo(res.Link);

            //StateHasChanged();
        }

    }
   }