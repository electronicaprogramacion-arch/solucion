@page "/"
@using CalibrationSaaS.Infraestructure.Blazor.Services.Offline.Sqlite
@using CalibrationSaaS.Infraestructure.Blazor.Shared
@using System.Drawing

@using Microsoft.Extensions.Configuration
@using ProtoBuf.Grpc
@using Grpc.Core
@using Blazed.Controls
@using System.Timers
@using System.Globalization
@using Radzen
@using Radzen.Blazor
@inherits Microsoft.AspNetCore.Components.ComponentBase



@using SqliteWasmHelper
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims




@if (this.Loading)
{
    <div class="loading-container">
        <p><em>Loading...</em></p>
        <FluentProgressRing></FluentProgressRing>
    </div>
}
        else
        {
            <RadzenStack Gap="1rem">
                <!-- Page Heading -->
                @* <RadzenText TextStyle="TextStyle.H4" class="rz-my-4">Dashboard</RadzenText> *@

                <!-- Chart Color Scheme Selector -->
                <RadzenCard class="rz-mb-4">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Wrap="FlexWrap.Wrap">
                        <RadzenLabel Text="Color Scheme" Component="ColorScheme" />
                        <RadzenDropDown Data="@colorSchemes" @bind-Value="@colorScheme" Name="ColorScheme">
                            <Template Context="colorSchemeItem">
                                @Enum.GetName(typeof(ColorScheme), colorSchemeItem)
                            </Template>
                        </RadzenDropDown>
                    </RadzenStack>
                </RadzenCard>

                <!-- Main Dashboard Content -->
                <RadzenRow Gap="1rem">
                    <!-- Area Chart -->
                    <RadzenColumn Size="12" SizeMD="8">
                        <RadzenCard>
                            <RadzenStack Gap="1rem">
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="Radzen.JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                    <RadzenText TextStyle="TextStyle.H6" class="rz-mb-0">Orders</RadzenText>
                                    <RadzenDropDown TValue="string" Style="width: 40px"
                                        Data=@(new[] { "Actions", "View Details", "Export Data", "View All" })
                                        Change=@OnActionChange
                                        ButtonStyle="ButtonStyle.Light"
                                        ButtonClick=@OnMenuButtonClick>
                                        <Template Context="actionItem">
                                            <RadzenIcon Icon="more_vert" />
                                        </Template>
                                    </RadzenDropDown>
                                </RadzenStack>

                                <div class="chart-container" style="height: 300px;">
                                    @if (AppStateBasics != null && AppStateBasics.WODByDay != null && AppStateBasics.WODByDay.Count() > 0)
                                    {
                                        <RadzenChart ColorScheme="@colorScheme">
                                            <RadzenLineSeries Data="@chartLineData" CategoryProperty="Date" Title="Jobs per day" ValueProperty="Count">
                                                <RadzenMarkers MarkerType="MarkerType.Circle" />
                                            </RadzenLineSeries>
                                            <RadzenCategoryAxis>
                                                <RadzenGridLines Visible="true" />
                                            </RadzenCategoryAxis>
                                            <RadzenValueAxis>
                                                <RadzenGridLines Visible="true" />
                                            </RadzenValueAxis>
                                            <RadzenLegend Position="LegendPosition.Bottom" />
                                        </RadzenChart>
                                    }
                                </div>
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>

                    <!-- Pie Chart -->
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenCard>
                            <RadzenStack Gap="1rem">
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="Radzen.JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                    <RadzenText TextStyle="TextStyle.H6" class="rz-mb-0">Order Status</RadzenText>
                                    <RadzenDropDown TValue="string" Style="width: 40px"
                                        Data=@(new[] { "Actions", "View Details", "Export Data", "View All" })
                                        Change=@OnActionChange
                                        ButtonStyle="ButtonStyle.Light"
                                        ButtonClick=@OnMenuButtonClick>
                                        <Template Context="pieChartMenu">
                                            <RadzenIcon Icon="more_vert" />
                                        </Template>
                                    </RadzenDropDown>
                                </RadzenStack>

                                <div class="chart-container" style="height: 300px;">
                                    @if (AppStateBasics != null && AppStateBasics.WODStatus != null)
                                    {
                                        <RadzenChart ColorScheme="@colorScheme">
                                            <RadzenPieSeries Data="@chartPieData" Title="Order Status" CategoryProperty="Status" ValueProperty="Count">
                                                <RadzenLegend Position="LegendPosition.Bottom" />
                                            </RadzenPieSeries>
                                        </RadzenChart>
                                    }
                                </div>
                            </RadzenStack>
                        </RadzenCard>

                        <RadzenCard class="rz-mt-4">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                                <RadzenIcon Icon="assignment" Style="font-size: 2.5rem; color: var(--rz-info);" />
                                <RadzenStack Gap="0">
                                    <RadzenText TextStyle="TextStyle.Overline">ACTIVE WORK ORDER DETAILS</RadzenText>
                                    <RadzenText TextStyle="TextStyle.H5" class="rz-mb-0">
                                        @(AppStateBasics?.ActiveWorkOrderDetails ?? 0)
                                    </RadzenText>
                                    @if (Customer?.ToLower() == "lti")
                                    {
                                        <RadzenLink Path="BackLog/0" Text="View Details" />
                                    }
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>
                </RadzenRow>

                <!-- Additional Dashboard Widgets -->
                <RadzenRow Gap="1rem" class="rz-mt-4">
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenCard>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                                <RadzenIcon Icon="assignment_turned_in" Style="font-size: 2.5rem; color: var(--rz-success);" />
                                <RadzenStack Gap="0">
                                    <RadzenText TextStyle="TextStyle.Overline">TOTAL WORK ORDERS</RadzenText>
                                    <RadzenText TextStyle="TextStyle.H5" class="rz-mb-0">
                                        @(AppStateBasics?.TotalWorkOrder ?? 0)
                                    </RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>

                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenCard>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                                <RadzenIcon Icon="pending_actions" Style="font-size: 2.5rem; color: var(--rz-warning);" />
                                <RadzenStack Gap="0">
                                    <RadzenText TextStyle="TextStyle.Overline">UPCOMING WORK ORDERS</RadzenText>
                                    <RadzenText TextStyle="TextStyle.H5" class="rz-mb-0">
                                        @(AppStateBasics?.UpcomingWorkOrderDetails ?? 0)
                                    </RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>

                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenCard>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
                                <RadzenIcon Icon="business" Style="font-size: 2.5rem; color: var(--rz-primary);" />
                                <RadzenStack Gap="0">
                                    <RadzenText TextStyle="TextStyle.Overline">CUSTOMER</RadzenText>
                                    <RadzenText TextStyle="TextStyle.H5" class="rz-mb-0">
                                        @(Customer ?? "")
                                    </RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>
                </RadzenRow>

                <!-- Dashboard Actions -->
                @* <RadzenRow class="rz-mt-4">
                    <RadzenColumn Size="12">
                        <RadzenCard>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" Wrap="FlexWrap.Wrap">
                                <RadzenButton Text="New Customer" Icon="person_add" ButtonStyle="ButtonStyle.Primary" Click="NavigateCustomer" />
                                <RadzenButton Text="New Asset" Icon="inventory" ButtonStyle="ButtonStyle.Secondary" Click="NavigateAsset" />
                                <RadzenButton Text="New Order" Icon="add_task" ButtonStyle="ButtonStyle.Info" Click="NavigateOrder" />
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>
                </RadzenRow> *@
            </RadzenStack>

            <div id="modalWindow">
                <ModalWindow Type="Customer"></ModalWindow>
            </div>
            <div id="modalWindow2">
                <ModalWindow Type="Assets"></ModalWindow>
            </div>
        }


@code{
    [Inject]
    public IConfiguration Configuration { get; set; }
    public string Customer { get; set; }

    // Properties from KavokuComponentBase2
    public bool Loading { get; set; }

    [Inject]
    public CalibrationSaaS.Domain.Aggregates.Shared.AppSecurity AppSecurity { get; set; }

    [Inject]
    public IJSRuntime JSRuntime { get; set; }





    // Add CascadingParameter for MainLayout
    [CascadingParameter]
    private MainLayout MainLayoutReference { get; set; }

    private static System.Timers.Timer aTimer;

    // Define RenderFragment for buttons to pass to SubMenu using RadzenButtons
    private RenderFragment DashboardButtons => builder =>
    {
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "dashboard-buttons");

        // New Customer button
        builder.OpenComponent<RadzenButton>(2);
        builder.AddAttribute(3, "Text", "New Customer");
        builder.AddAttribute(4, "Icon", "person_add");
        builder.AddAttribute(5, "ButtonStyle", ButtonStyle.Primary);
        builder.AddAttribute(6, "Click", EventCallback.Factory.Create<MouseEventArgs>(this, NavigateCustomer));
        builder.AddAttribute(7, "class", "rz-mr-2 action-button");
        builder.CloseComponent();

        // New Asset button
        builder.OpenComponent<RadzenButton>(8);
        builder.AddAttribute(9, "Text", "New Asset");
        builder.AddAttribute(10, "Icon", "inventory");
        builder.AddAttribute(11, "ButtonStyle", ButtonStyle.Primary);
        builder.AddAttribute(12, "Click", EventCallback.Factory.Create<MouseEventArgs>(this, NavigateAsset));
        builder.AddAttribute(13, "class", "rz-mr-2 action-button");
        builder.CloseComponent();

        // New Order button
        builder.OpenComponent<RadzenButton>(14);
        builder.AddAttribute(15, "Text", "New Order");
        builder.AddAttribute(16, "Icon", "shopping_cart");
        builder.AddAttribute(17, "ButtonStyle", ButtonStyle.Primary);
        builder.AddAttribute(18, "Click", EventCallback.Factory.Create<MouseEventArgs>(this, NavigateOrder));
        builder.AddAttribute(19, "class", "action-button");
        builder.CloseComponent();

        builder.CloseElement(); // close div
    };

    // Event handlers for dropdown menu actions
    void OnActionChange(object value)
    {
        Console.WriteLine($"Selected: {value}");
    }

    void OnMenuButtonClick(MouseEventArgs args)
    {
        // Button click handler (if needed)
    }

    // Radzen chart color scheme
    IEnumerable<ColorScheme> colorSchemes = Enum.GetValues(typeof(ColorScheme)).Cast<ColorScheme>();
    ColorScheme colorScheme = ColorScheme.Palette;

    // Data models for Radzen charts
    class ChartDataItem
    {
        public DateTime Date { get; set; }
        public int Count { get; set; }
    }

    class PieChartDataItem
    {
        public string Status { get; set; }
        public int Count { get; set; }
    }

    // Collection to hold line chart data
    private List<ChartDataItem> chartLineData = new List<ChartDataItem>();
    // Collection to hold pie chart data
    private List<PieChartDataItem> chartPieData = new List<PieChartDataItem>();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Set the buttons in the SubMenu when the Index component is first rendered
            if (MainLayoutReference != null)
            {
                MainLayoutReference.SetSubMenuContent(DashboardButtons);
            }
        }

        if ((AppStateBasics?.TotalWorkOrder.HasValue == true &&
             AppStateBasics?.UpcomingWorkOrderDetails.HasValue == true &&
             AppStateBasics?.ActiveWorkOrderDetails.HasValue == true))
        {
            if ((TotalWorkOrder != AppStateBasics.TotalWorkOrder) ||
                UpcomingWorkOrderDetails != AppStateBasics.UpcomingWorkOrderDetails ||
                ActiveWorkOrderDetails != AppStateBasics.ActiveWorkOrderDetails)
            {
                TotalWorkOrder = AppStateBasics.TotalWorkOrder.Value;
                UpcomingWorkOrderDetails = AppStateBasics.UpcomingWorkOrderDetails.Value;
                ActiveWorkOrderDetails = AppStateBasics.ActiveWorkOrderDetails.Value;
                StateHasChanged();
            }
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private string userIdentifier = string.Empty;

    private void OnUserFinish(Object source, ElapsedEventArgs e)
    {
        aTimer.Stop();
    }

    [Inject] public CalibrationSaaS.Domain.Aggregates.Shared.AppStateCompany AppState { get; set; }
    [Inject]
    public ISqliteWasmDbContextFactory<CalibrationSaaSDBContextOff2> DbFactory { get; set; }

    [Inject]
    public Func<dynamic, Application.Services.ISampleService2<CallContext>> OffLineClient { get; set; }

    public bool busy { get; set; }
    private async Task RefreshUiAsync()
    {
        busy = true;
        try
        {
            // Initialize the offline database
            await OffLineClient(DbFactory).InitializeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing database: {ex.Message}");
        }
        finally
        {
            busy = false;
        }
    }

    [Inject]
    public NavigationManager NavigationManager { get; set; }

    // Modified the return type from Task to void for Click handlers
    public void NavigateCustomer()
    {
        NavigationManager.NavigateTo("Customer/0");
    }

    public void NavigateAsset()
    {
        NavigationManager.NavigateTo("PieceOfEquipmentCreate/0");
    }

    public void NavigateOrder()
    {
        NavigationManager.NavigateTo("WorkOrderCreate/0");
    }

    public static string RolesC { get; set; }

    public int TotalWorkOrder { get; set; }
    public int UpcomingWorkOrderDetails { get; set; }
    public int ActiveWorkOrderDetails { get; set; }

    [Inject] public CalibrationSaaS.Domain.Aggregates.Shared.Basic.AppState AppStateBasics { get; set; }

    [Inject]
    Func<dynamic, Application.Services.IWorkOrderDetailServices<CallContext>> Service2 { get; set; }

    [Inject] public Func<dynamic, CalibrationSaaS.Application.Services.IUOMService<CallContext>> UOM { get; set; }
    [Inject] public Func<dynamic, CalibrationSaaS.Application.Services.IBasicsServices<CallContext>> Basics { get; set; }
    [Inject] public Func<dynamic, CalibrationSaaS.Application.Services.IAssetsServices<CallContext>> Assets { get; set; }

    private Task<Metadata> GetHeaderAsync()
    {
        var headers = new Metadata();
        return Task.FromResult(headers);
    }

    public async Task<CurrentUser> GetTechOffline()
    {
        CurrentUser uss1 = await OffLineClient(DbFactory).GetUser(new CallOptions());
        BasicsServiceGRPC basics = new BasicsServiceGRPC(Basics, DbFactory);
        var users = await basics.GetUsers();

        if (uss1?.Claims?.Count > 5)
        {
            var user = uss1.Claims.Where(x => x.Key == "name").FirstOrDefault();

            if (user != null)
            {
                var uss = users.Users.Where(x => x.UserName == user.Value).FirstOrDefault();
                if (uss != null)
                {
                    uss1.Name = uss.Name;
                    uss1.TechID = uss.UserID;
                    uss1.Roles = uss.Roles;
                    return uss1;
                }
            }
        }
        return null;
    }

    protected override async Task OnInitializedAsync()
    {
        await RefreshUiAsync();
        this.Loading = true;

        if (AppStateBasics == null)
        {
            return;
        }

        try
        {
            // Always run in offline mode
            WorkOrderDetailGrpc client = new WorkOrderDetailGrpc(Service2, DbFactory);

            var s = await client.GetStatus(new CallOptions());
            if (s != null)
            {
                AppStateBasics.WODStatus = s.ToList();
            }

            var ac = await client.GetChartPie(new CallOptions());
            if (ac != null)
            {
                AppStateBasics.WODStatusCount = ac;
            }

            var ta = await client.GetTotals(new CallOptions());
            if (ta != null)
            {
                AppStateBasics.TotalWorkOrder = ta.ElementAtOrDefault(0);
                AppStateBasics.UpcomingWorkOrderDetails = ta.ElementAtOrDefault(1);
                AppStateBasics.ActiveWorkOrderDetails = ta.ElementAtOrDefault(2);
            }

            var res = await client.GetWODCountPerDay(new CallOptions());
            if (res != null)
            {
                AppStateBasics.WODByDay = res;
            }

            // Prepare data for Radzen charts
            UpdateChartData();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
            // Continue even if there's an error loading data
        }

        aTimer = new System.Timers.Timer(100);
        aTimer.AutoReset = false;
        aTimer.Elapsed += OnUserFinish;
        aTimer.Stop();
        aTimer.Start();

        Customer = Configuration.GetSection("Reports")["Customer"];
        this.Loading = false;
    }

    private void UpdateChartData()
    {
        // Prepare data for Line Chart
        if (AppStateBasics?.WODByDay != null)
        {
            chartLineData.Clear();
            foreach (var item in AppStateBasics.WODByDay)
            {
                chartLineData.Add(new ChartDataItem
                {
                    Date = item.Key,
                    Count = item.Value
                });
            }
        }

        // Prepare data for Pie Chart
        if (AppStateBasics?.WODStatus != null && AppStateBasics?.WODStatusCount != null)
        {
            chartPieData.Clear();
            var statusList = AppStateBasics.WODStatus.Where(x => x.IsLast == false).ToList();
            var statusCountArray = AppStateBasics.WODStatusCount.ToArray();

            for (int i = 0; i < statusList.Count && i < statusCountArray.Length; i++)
            {
                chartPieData.Add(new PieChartDataItem
                {
                    Status = statusList[i].Name,
                    Count = statusCountArray[i]
                });
            }
        }
    }
}
