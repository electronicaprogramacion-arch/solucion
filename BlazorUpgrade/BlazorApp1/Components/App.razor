@namespace BlazorApp.Blazor
@using CalibrationSaaS.Infraestructure.Blazor
@using NetEscapades.AspNetCore.SecurityHeaders
@inject IHostEnvironment Env

@inherits FComponentBase
<!DOCTYPE html>
<html lang="en"  dir="@(ThemeService.RightToLeft == true ? "rtl" : "ltr")">

<head>
    @* <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />
    <link rel="stylesheet" href="@Assets["lib/bootstrap/dist/css/bootstrap.min.css"]" />
    <link rel="stylesheet" href="@Assets["app.css"]" />
    <link rel="stylesheet" href="@Assets["BlazorApp1.styles.css"]" />
    <ImportMap />
    <link rel="icon" type="image/png" href="favicon.png" />
    <HeadOutlet /> *@
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />
   @*  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script> *@
    <link rel="stylesheet" href="@Assets["lib/bootstrap/dist/css/bootstrap.min.css"]" />
    <link rel="stylesheet" href="@Assets["app.css"]" />
    <link rel="stylesheet" href="@Assets["BlazorApp1.styles.css"]" />
    <link href="lib/fontawesome-free/css/all.min.css" rel="stylesheet" />

    <!-- Radzen Components -->
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/material-base.css">
    
    <link rel="icon" type="image/png" href="favicon.png" />

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <!--<meta name="viewport" id="testViewport" content="width=device-width, initial-scale=0.75, maximum-scale=0.75, user-scalable=no" />-->
    <meta name="viewport" id="testViewport" content="width=device-width, initial-scale=0.75, maximum-scale=0.75" />
    <title>Phoenix Calibration</title>
    <meta name="description" content="Cloud Based Calibration Management System">
    <meta name="author" content="Kavoku, LLC">
    <base href="/" />

    <link href="manifest.json" rel="manifest" />
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />
    <!--Style-->
    <!-- Custom fonts for this template-->
    <link href="lib/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
    <!-- Custom styles for this template-->
    <link href="lib/bootstrap/dist/css/bootstrap.css" rel="stylesheet" />
     <link href="css/sb-admin-2.css" rel="stylesheet">
    <link href="css/site.css" rel="stylesheet" />
    <link href="_content/Blazored.Modal/blazored-modal.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!--Reports Script-->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.0.943/pdf.min.js"></script>-->

    @* <script src="lib/jquery/dist/jquery.min.js"></script> *@
    <script src="js/pdf.min.js"></script>
    <script src="js/pdf.worker.min.js"></script>
    <script src="js/getReportCanvasDemo.js?v3"></script>
    <link href="css/BlazorControls.css" rel="stylesheet">
    <script src="js/print.min.js"></script>
    <link href="css/print.min.css" rel="stylesheet" />

    <link href="css/index1.css" rel="stylesheet" />

    <script src="_content/Fluxor.Blazor.Web/scripts/index.js"></script>


    <!-- Radzen Blazor dependencies -->
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/default-base.css" data-theme="default">
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/dark-base.css" data-theme="dark" disabled>
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/software-base.css" data-theme="software" disabled>
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/software-dark-base.css" data-theme="software-dark" disabled>
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/humanistic-base.css" data-theme="humanistic" disabled>
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/humanistic-dark-base.css" data-theme="humanistic-dark" disabled>
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/standard-base.css" data-theme="standard" disabled>
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/standard-dark-base.css" data-theme="standard-dark" disabled>
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/material-base.css" data-theme="material" disabled>
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/material-dark-base.css" data-theme="material-dark" disabled>
    <link rel="stylesheet" href="css/radzen-custom.css">

    <!-- Theme handling scripts -->
    <script src="js/theme.js"></script>

    <script src="js/blazor-error-handler.js"></script>
    <!-- Add PWA Manager for offline functionality -->
    <script src="js/pwa-manager.js"></script>


    <HeadOutlet @rendermode="Rendermode" />


    <RadzenComponents @rendermode="Rendermode" />
    <RadzenTheme Theme="material3" @rendermode="Rendermode" />

   @*  <ImportMap AdditionalAttributes="@(new Dictionary<string, object>() { { "nonce", Nonce ?? "" } })" @rendermode="Rendermode" /> *@


</head>

<body class="rz-scrollbars">

    <script src="js/offline-detector.js"></script>
    <script src="js/cache-warmer.js"></script>
    <div id="reconnect-modal" style="display: none;">

        reconect

    </div>
    <div id="blazor-error-ui">
        @if (Env.IsDevelopment())
        {
            <text>
                An unhandled exception has occurred. See browser dev tools for details.
            </text>
        }
        else
        {
            <text>
                An error has occurred. This app may no longer respond until reloaded.
            </text>
        }
        <a href="" class="reload">Reload</a>
        <a class="dismiss">🗙</a>
    </div>
    <!-- Bootstrap core JavaScript-->
    <script src="lib/jquery/dist/jquery.min.js"></script>


   
  

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.js"></script>
    <!-- Add PDB error handler script before Blazor scripts -->
    @* <script src="js/pdb-error-handler.js"></script> *@


  @*   @{
        if (1 == 1)
        {
            IComponentRenderMode assignedRenderMode = AssignedRenderMode;
            if (assignedRenderMode != null)
            {
                var app = assignedRenderMode;
            }
            
            var a = OperatingSystem.IsBrowser();
        }
    } *@


    @if (!RendererInfo.IsInteractive)
    {
        <div id="wrappercde">
            <div style="position:absolute; top:30vh; width:100%; text-align:center">
                <h1>Calibration Management System</h1>
                <p><i class="fas fa-spin fa-spinner"></i> The application is loading...</p>
            </div>
        </div>
    }
    else
    {
        
    }

    <BlazorApp1.Client.Routes @rendermode=Rendermode />
    
    <div id="app">
    </div>



    <script src="_content/Microsoft.Authentication.WebAssembly.Msal/AuthenticationService.js"></script>
    <script src="_content/Microsoft.AspNetCore.Components.WebAssembly.Authentication/AuthenticationService.js"></script>

    <script src="_framework/blazor.web.js" autostart="false"></script>

    @* <script>
        Blazor.start({
          loadBootResource: function (type, name, defaultUri, integrity) {
            if (type == 'dotnetjs') {
              return null;
            } else {
              return fetch(defaultUri, {
                cache: 'no-cache',
                integrity: integrity,
                headers: { 'Custom-Header': 'Custom Value' }
              });
            }
          },
          webAssembly: {},
          configureSignalR: function (builder) {
            let c = builder.build();
            c.serverTimeoutInMilliseconds = 30000;
            c.keepAliveIntervalInMilliseconds = 15000;
            c.withUrl("/signalr")
            builder.build = () => {
              return c;
            };
          },
          reconnectionOptions: {
                maxRetries: 1000,
                retryIntervalMilliseconds: 500
            }
        });
    </script> *@
    @* <script>
        Blazor.start({
            webAssembly: {}
        });
    </script>

    <script>
         Blazor.start({
          configureSignalR: builder => builder.withUrl("/signalr")
          });
    </script>


    <script>
        Blazor.start({
            reconnectionOptions: {
                maxRetries: 1000,
                retryIntervalMilliseconds: 500
            }
        });
    </script> *@
    @* <script>
        Blazor.start({
            configureSignalR: function (builder) {
                builder.withServerTimeout(3600000).withKeepAliveInterval(3600000);
            });
    </script> *@
    @* <script>
        Blazor.start({
          configureSignalR: function (builder) {
            let c = builder.build();
            c.serverTimeoutInMilliseconds = 30000;
            c.keepAliveIntervalInMilliseconds = 15000;
            c.withUrl("/signalr")
            builder.build = () => {
              return c;
            };
          }
        });
    </script> *@

@*     <script>
        Blazor.start().then(() => {
            Blazor.defaultReconnectionHandler._reconnectCallback = function (d) {
                document.location.reload();
            }
        });
    </script> *@
   @*  <script>
        Blazor.start({
          reconnectionOptions: {
            maxRetries: 3,
            retryIntervalMilliseconds: 2000
          }
        });
    </script> *@


    @*  <script>navigator.serviceWorker.register('service-worker.js');</script> *@
    <script src="_content/Blazored.Modal/blazored.modal.js"></script>

    <!--<script src="js/BlazorControls.js"></script>-->
    <!--<script src="inputfile.js"></script>-->
    <script src="_content/CEC.Routing/cec.routing.js"></script>
    <script src="_content/BrowserInterop/scripts.js"></script>
    <script src="_content/BlazorInputFile/inputfile.js"></script>
    <script src="js/dexie.min.js"></script>
    <script src="js/dexie-export-import.js"></script>
    <script src="js/download.min.js"></script>
    
    <script src="_content/Radzen.Blazor/Radzen.Blazor.js?v=@(typeof(Radzen.Colors).Assembly.GetName().Version)"></script>
  
    @* <script src="Offline/js/jquery-3.7.1.min.js"></script> *@
    <!-- Core plugin JavaScript-->
    <script src="lib/jquery-easing/jquery.easing.min.js"></script>
    <script src="Offline/js/sql-wasm.js?v=1100"></script>
    <script src="Offline/js/select2.min.js?v=4013"></script>
    <script src="Offline/js/ace/ace.js?v=1323"></script>
    <script src="Offline/js/bootstrap.bundle.min.js?v=532"></script>
    <script src="js/index1.js?v=asasas115"></script>
    @*  <script src="lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script> *@

    <script>
        document.addEventListener("visibilitychange", async function () {
            if (document.visibilityState === 'visible') {
                try {
                    // Enhanced connection check with timeout
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Connection check timeout')), 5000)
                    );
                    
                    const connectionCheck = DotNet.invokeMethodAsync('BlazorApp1.Client', 'CheckConnection');
                    
                    await Promise.race([connectionCheck, timeoutPromise]);
                    console.log("Connection active");
                } catch (error) {
                    console.log("Connection lost or timeout, reloading page...", error.message);
                    window.location.reload();
                }
            }
        });
    </script>
    <script src="boot.js"></script>
</body>

</html>
@code {

    //new InteractiveWebAssemblyRenderMode(prerender: false);//
    //IComponentRenderMode Rendermode { get; set; } =  new InteractiveWebAssemblyRenderMode(prerender: false);
    //public IComponentRenderMode Rendermode { get; set; } = new InteractiveServerRenderMode(prerender: false);
    //IComponentRenderMode Rendermode { get; set; } = new InteractiveAutoRenderMode(prerender: false);
    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    public string? Nonce => HttpContextAccessor?.HttpContext?.GetNonce();
    [Inject] private IHttpContextAccessor? HttpContextAccessor { get; set; }


    private IComponentRenderMode? RenderModeForPage =>
        HttpContext.GetEndpoint()?.Metadata.GetMetadata<RenderModeAttribute>()?
            .Mode;



    [Inject]
    private ThemeService ThemeService { get; set; }

    protected override async Task OnInitializedAsync()
    {

        

        await base.OnInitializedAsync();
    }


   

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {

        if (firstRender)
        {

            if (HttpContext != null)
            {
                var theme = HttpContext.Request.Cookies["CalibrifyTheme"];

                if (!string.IsNullOrEmpty(theme))
                {
                    ThemeService.SetTheme(theme, false);
                }
            }
            // if( await IsOffline())
            // {
            //     Rendermode = new InteractiveWebAssemblyRenderMode(prerender: false);
            // }

            Console.WriteLine("APP++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++");

        }

        await base.OnAfterRenderAsync(firstRender);
    }

}
