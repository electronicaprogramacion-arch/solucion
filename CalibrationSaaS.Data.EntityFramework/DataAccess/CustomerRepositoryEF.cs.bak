using CalibrationSaaS.Data.EntityFramework;
using CalibrationSaaS.Domain.Aggregates.Entities;
using CalibrationSaaS.Domain.Aggregates.Querys;
using CalibrationSaaS.Domain.Aggregates.ValueObjects;
using CalibrationSaaS.Domain.Repositories;
using CalibrationSaaS.Infraestructure.EntityFramework.Helpers;
using Helpers.Controls.ValueObjects;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Runtime.CompilerServices;
using System.Text;
using System.Threading.Tasks;

namespace CalibrationSaaS.Infraestructure.EntityFramework.DataAccess
{
    public class CustomerRepositoryEF<TContext> : ICustomerRepository, IDisposable where TContext : DbContext, ICalibrationSaaSDBContextBase
    {
        private readonly IDbContextFactory<TContext> DbFactory;


        public CustomerRepositoryEF(IDbContextFactory<TContext> dbFactory)
        {
            DbFactory = dbFactory;
        }

        public async Task<Customer> DeleteCustomer(Customer customerDTO)
        {
            await using var context = await DbFactory.CreateDbContextAsync();
            //customerDTO.IsDelete = true;
            context.Entry(customerDTO).State = EntityState.Deleted;
                
                await context.SaveChangesAsync();
                return customerDTO;
            
           
        }

        public async Task<Address> DeleteAddress(Address DTO)
        {
            await using var context = await DbFactory.CreateDbContextAsync();
            //DTO.Delete = true;
            context.Entry(DTO).State = EntityState.Deleted;
            //context.Update(DTO);
            await context.SaveChangesAsync();
            return DTO;

        }

        public async Task<Contact> DeleteContact(Contact DTO)
        {
            await using var context = await DbFactory.CreateDbContextAsync();
            //DTO.Delete = true;
            context.Entry(DTO).State = EntityState.Deleted;
            //context.Update(DTO);
            await context.SaveChangesAsync();
            return DTO;

        }


        public async Task<PhoneNumber> DeletePhone(PhoneNumber   DTO)
        {
            await using var context = await DbFactory.CreateDbContextAsync();

            try
            {
                context.Entry(DTO).State = EntityState.Deleted;
                await context.SaveChangesAsync();
                return DTO;
            }
            catch (Exception ex)
            {
                return null;
            
            }



        }

        public async Task<Social> DeleteSocial(Social DTO)
        {

            context.Entry(DTO).State = EntityState.Deleted;
            await context.SaveChangesAsync();
            return DTO;


        }


        public async Task<string> ValidateCustomer(Customer customerDTO)
        {
            string result = "";

            Customer customer = await context.Customer
                .FirstOrDefaultAsync(sc => 
                sc.Name.ToLower()== customerDTO.Name.ToLower()
                
                );
            
            if(customer != null)
            {
                return "Name already exists";
            }


          
            foreach (var item in customerDTO.Aggregates)
            {

                foreach (var item2 in item.Contacts)
                {

                    Contact Contact = await context.Contact
                   .FirstOrDefaultAsync(sc => 
                    item2.Email != null && item2.IsDelete == false && (sc.Email.ToLower() == item2.Email.ToLower())
                    && (item2.UserName != null && sc.UserName == item2.UserName) );

                    if (Contact != null)
                    {
                        return "Contact already exists";
                    }
                }
            }

           
            return result;
        }



        public async Task<Customer> GetCustomerByID(Customer id)
        {

            try
            {
                var address = new List<Address>();
                var contacts = new List<Contact>();

                var phone = new List<Address>();
                var result = await context.Customer
                    .Include(x => x.Aggregates)
                    .ThenInclude(d => d.Addresses)
                    .Include(x => x.Aggregates)
                    .ThenInclude(d => d.Contacts)
                    .Include(x => x.Aggregates)
                    .ThenInclude(d => d.PhoneNumbers)
                    .Include(x => x.Aggregates)
                    .ThenInclude(d => d.Socials)

                    .Where(x => x.CustomerID == id.CustomerID).AsNoTracking().FirstOrDefaultAsync();

                return result;
            }
            catch (Exception ex)
            {
                return null;
            }
            
            
        }





        //public async Task<Customer> GetCustomerByName(string id)
        //{
        //    var result = await context.Customer
        //        //.Include(x => x.Aggregates)
        //        //.ThenInclude(d => d.Addresses)
        //        //.Include(x => x.Aggregates)
        //        //.ThenInclude(d => d.Contacts)
        //        //.Include(x => x.Aggregates)
        //        //.ThenInclude(d => d.PhoneNumbers)
        //        .Where(x => x.Name.ToLower() == id.ToLower()).AsNoTracking().FirstOrDefaultAsync();
        //    return result;
        //}

        public async Task<ResultSet<Customer>> GetCustomers(Pagination<Customer> pagination)
        {
   
            var filterQuery = Querys.CustomerFilter(pagination.Filter);
            var queriable = context.Customer;//context.PieceOfEquipment.Include(x => x.EquipmentTemplate).Include(d => d.Customer).AsQueryable();
            var simplequery = context.Customer;

            //if (pagination.Filter == null)
            //{
            //    pagination.Filter = "Delete";
            //}
            //var result = await QueryableExtensions.PaginationAndFilterQuery<PieceOfEquipment>(exprTree, pagination, context.PieceOfEquipment, queriable);
            var result = await queriable.PaginationAndFilterQuery<Customer>( pagination, simplequery, filterQuery);
           

            return result;

        }

        public async Task<Customer> InsertCustomer(Customer newCustomer)
        {
            try
            {
                
                var res = await GetCustomerByID(newCustomer);
                if (res != null)
                {
                    var x = await UpdateCustomer(newCustomer);
                   

                }
                else
                {
                    context.Customer.Add(newCustomer);
                  
                }
                await context.SaveChangesAsync();

                return await GetCustomerByID(newCustomer);
            }
            catch (Exception ex)
            {
                return null;
            }
        }

        public async Task<Customer> UpdateCustomer(Customer newCustomer)
        {

            //if(newCustomer?.Aggregates?.Count > 0)
            //{

            //   foreach(var item in newCustomer.Aggregates)
            //    {

            //        if(item.Contacts != null)
            //        {

            //            foreach(var cont in item.Contacts)
            //            {
            //                var a = await context.Contact.Where(x => x.ContactID == cont.ContactID).FirstOrDefaultAsync();
            //                if (a == null)
            //                {
            //                    context.Contact.Add(cont);
            //                }
            //                else
            //                {
            //                    context.Contact.Update(cont);
            //                }

            //                await context.SaveChangesAsync();
            //            }
            //        }




            //    }






            //}

           

            await RemoveAddress(newCustomer);
            
            await RemoveContacts(newCustomer);

            await RemovePhoneNumber(newCustomer);

            await RemoveSocial(newCustomer);

            if (newCustomer?.Aggregates?.ElementAtOrDefault(0) != null)
            {
                newCustomer.Aggregates.ElementAtOrDefault(0).Addresses = null;
                newCustomer.Aggregates.ElementAtOrDefault(0).Contacts = null;
                newCustomer.Aggregates.ElementAtOrDefault(0).PhoneNumbers = null;
                newCustomer.Aggregates.ElementAtOrDefault(0).Socials = null;
            }


            context.Customer.Update(newCustomer);
            //context.Entry(a).State= EntityState.Modified;
            await context.SaveChangesAsync();
            return newCustomer;
        }


        public async Task RemoveAddress(Customer newCustomer)
        {




            var a = await context.CustomerAggregates.Include(x => x.Addresses).Where(x => x.CustomerID == newCustomer.CustomerID).ToListAsync();

            if (a.Count > 0)
            {
                var adds = new List<Address>();
                if (newCustomer?.Aggregates?.ElementAtOrDefault(0)?.Addresses?.Count > 0)
                {
                    adds = newCustomer.Aggregates.ElementAtOrDefault(0).Addresses.ToList();

                }
                else
                {



                }
                foreach (var item in a)
                {                   

                    foreach (var item2 in item.Addresses)
                    {

                        var match = adds.Where(x => x.AddressId == item2.AddressId).FirstOrDefault();

                        if (match == null)
                        {
                            item2.IsDelete = true;

                            //context.Address.Update(item2);
                            context.Address.Remove(item2);

                            await context.SaveChangesAsync();
                        }
                        //else
                        //{
                        //    context.Address.Update(item2);

                        //    await context.SaveChangesAsync();
                        //}
                    }
                    foreach (var item2 in adds)
                    {

                        if (item2.AddressId == 0)
                        {
                            item2.AggregateID = item.AggregateID;
                            item2.CustomerAggregateAggregateID = item.AggregateID;
                            context.Address.Add(item2);

                            await context.SaveChangesAsync();
                        }
                        else
                        {
                            context.Address.Update(item2);

                            await context.SaveChangesAsync();
                        }
                    }
                }
            }
        }

        public async Task RemoveContacts(Customer newCustomer)
        {
            var a = await context.CustomerAggregates.Include(x => x.Contacts).Where(x => x.CustomerID == newCustomer.CustomerID).ToListAsync();

            if (a.Count > 0)
            {
                var adds = new List<Contact>();
                if (newCustomer?.Aggregates?.ElementAtOrDefault(0)?.Contacts?.Count > 0)
                {
                    adds = newCustomer.Aggregates.ElementAtOrDefault(0).Contacts.ToList();
                }
                else
                {



                }
                
                    foreach (var item in a)
                {

                    //foreach (var item2 in item.Contacts)
                    foreach (var item2 in item.Contacts)
                    {

                        var match = adds.Where(x => x.ContactID == item2.ContactID).FirstOrDefault();

                        if (match == null)
                        {
                            item2.IsDelete = true;

                            //context.Address.Update(item2);
                            context.Contact.Remove(item2);

                            await context.SaveChangesAsync();
                        }
                        
                    }

                    foreach (var item2 in adds)
                    {

                        if (item2.ContactID == 0)
                        {
                            item2.AggregateID = item.AggregateID;
                            item2.CustomerAggregateAggregateID = item.AggregateID;
                            context.Contact.Add(item2);

                            await context.SaveChangesAsync();
                        }
                        else

                        {
                            context.Contact.Update(item2);

                            await context.SaveChangesAsync();

                        }
                    }
                }
            }
        }


        public async Task RemovePhoneNumber(Customer newCustomer)
        {
            var a = await context.CustomerAggregates.Include(x => x.PhoneNumbers).Where(x => x.CustomerID == newCustomer.CustomerID).ToListAsync();

            if (a.Count > 0)
            {
                var adds = new List<PhoneNumber>();
                if (newCustomer?.Aggregates?.ElementAtOrDefault(0)?.PhoneNumbers?.Count > 0)
                {
                    adds = newCustomer.Aggregates.ElementAtOrDefault(0).PhoneNumbers.ToList();
                }
                else
                {



                }
                foreach (var item in a)
                {

                    foreach (var item2 in item.PhoneNumbers)
                    {

                        var match = adds.Where(x => x.PhoneNumberID == item2.PhoneNumberID).FirstOrDefault();

                        if (match == null)
                        {
                            

                            //context.Address.Update(item2);
                            context.PhoneNumber.Remove(item2);

                            await context.SaveChangesAsync();
                        }
                        //else
                        //{
                        //    context.PhoneNumber.Update(item2);

                        //    await context.SaveChangesAsync();
                        //}
                    }
                    foreach (var item2 in adds)
                    {

                        if (item2.PhoneNumberID == 0)
                        {
                            //item2.AggregateID = item.AggregateID;
                            item2.CustomerAggregateAggregateID = item.AggregateID;
                            context.PhoneNumber.Add(item2);

                            await context.SaveChangesAsync();
                        }
                        else
                        {
                            context.PhoneNumber.Update(item2);

                            await context.SaveChangesAsync();
                        }
                    }
                }
            }
        }

        public async Task RemoveSocial(Customer newCustomer)
        {
            var a = await context.CustomerAggregates.Include(x => x.Socials).Where(x => x.CustomerID == newCustomer.CustomerID).ToListAsync();

            if (a.Count > 0)
            {
                var adds = new List<Social>();
                if (newCustomer?.Aggregates?.ElementAtOrDefault(0)?.Socials?.Count > 0)
                {
                    adds = newCustomer.Aggregates.ElementAtOrDefault(0).Socials.ToList();
                }
                else
                {



                }
                foreach (var item in a)
                {

                    foreach (var item2 in item.Socials)
                    {

                        var match = adds.Where(x => x.SocialID == item2.SocialID).FirstOrDefault();

                        if (match == null)
                        {
                            //context.Address.Update(item2);
                            context.Social.Remove(item2);

                            await context.SaveChangesAsync();
                        }
                        //else
                        //{
                        //    context.Social.Update(item2);

                        //    await context.SaveChangesAsync();
                        //}
                    }
                    foreach (var item2 in adds)
                    {

                        if (item2.SocialID == 0)
                        {
                            //item2.AggregateID = item.AggregateID;
                            item2.CustomerAggregateAggregateID = item.AggregateID;
                            context.Social.Add(item2);

                            await context.SaveChangesAsync();
                        }
                        else
                        {
                            context.Social.Update(item2);
                            await context.SaveChangesAsync();
                        }
                    }
                }
            }
        }

        public async Task<bool> Save()
        {
            return (await context.SaveChangesAsync()) > 0;
        }

        public async Task<Customer> GetCustomerByName(string name,string customname=null)
        {
            Customer customer = null;

            if (!string.IsNullOrEmpty(customname))
            {

                customer = await context.Customer.AsNoTracking().Where(c => !string.IsNullOrEmpty(customname) && c.CustomID.Equals(customname)).FirstOrDefaultAsync();
                
                if(customer != null) 
                {
                    return customer;
                }


            }

            if(customer==null && !string.IsNullOrEmpty(name) && !string.IsNullOrEmpty(customname))
            {
                var aaa = await context.Customer.AsNoTracking().Where(c => c.Name.Equals(name)).FirstOrDefaultAsync();

                return aaa;
            }
           
            
            if (string.IsNullOrEmpty(customname) && !string.IsNullOrEmpty(name))
            {
                var aaa = await context.Customer.AsNoTracking().Where(c => c.Name.Equals(name)).FirstOrDefaultAsync();

                return aaa;
            }
            //else if (!string.IsNullOrEmpty(customname) && !string.IsNullOrEmpty(name))
            //{
            //    var aaa2 = await context.Customer.AsNoTracking().Where(c =>  !string.IsNullOrEmpty(customname) && c.CustomID.Equals(customname)).FirstOrDefaultAsync();

            //    var aaa = await context.Customer.AsNoTracking().Where(c=> c.Name.Equals(name) && !string.IsNullOrEmpty(customname) && c.CustomID.Equals(customname)).FirstOrDefaultAsync();

            //    if(aaa2.Name.ToLower() != aaa.Name.ToLower())
            //    {
            //        throw new Exception("The EBMS ID code and the Customer name do not match consult your administrator");
            //    }

            //    return aaa;
            //}
            

            return null;
           
        }

        #region Dispose
        private bool disposed = false;

        protected virtual void Dispose(bool disposing)
        {
            if (!this.disposed)
            {
                if (disposing)
                {
                    context.Dispose();
                }
            }
            this.disposed = true;
        }

        public void Dispose()
        {
            Dispose(true);
            GC.SuppressFinalize(this);
        }

        public void InsertUser(User userDTO)
        {
            throw new NotImplementedException();
        }


        #endregion
    }
}
