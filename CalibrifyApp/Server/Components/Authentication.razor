@page "/auth/{action}"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Text.Json
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-body text-center p-5">
                    <img src="img/logo/Grayscale Transparent.svg" alt="Calibrify Logo" style="max-width: 200px; margin-bottom: 20px;" />
                    <h2 class="mb-4">Authentication in progress...</h2>
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <p class="mt-3">Please wait while we process your authentication request.</p>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string? Action { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public string? Code { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public string? State { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public string? Error { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public string? ErrorDescription { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine($"Authentication component initialized with action: {Action}");

        if (Action == "login-callback")
        {
            await HandleLoginCallback();
        }
        else if (Action == "login")
        {
            await HandleLogin();
        }
        else if (Action == "logout")
        {
            await HandleLogout();
        }
        else if (Action == "logout-callback")
        {
            await HandleLogoutCallback();
        }
        else
        {
            Navigation.NavigateTo("/");
        }
    }

    private async Task HandleLogin()
    {
        Console.WriteLine("Handling login...");

        try
        {
            // Get the identity server URL
            var authority = "https://localhost/";

            // Get the client ID
            var clientId = "CalibrationSaaS";

            // Get the redirect URI
            var redirectUri = Navigation.BaseUri + "auth/login-callback";

            // Get the response type
            var responseType = "code";

            // Get the scopes
            var scopes = "openid profile";

            // Generate a random state value
            var state = Guid.NewGuid().ToString("N");

            // Generate a code verifier and challenge
            var codeVerifier = GenerateCodeVerifier();
            var codeChallenge = GenerateCodeChallenge(codeVerifier);

            // Store the code verifier and state in session storage
            await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "codeVerifier", codeVerifier);
            await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "state", state);

            // Construct the authorization URL
            var authorizationUrl = $"{authority}connect/authorize" +
                $"?client_id={clientId}" +
                $"&redirect_uri={Uri.EscapeDataString(redirectUri)}" +
                $"&response_type={responseType}" +
                $"&scope={Uri.EscapeDataString(scopes)}" +
                $"&state={state}" +
                $"&code_challenge={codeChallenge}" +
                $"&code_challenge_method=S256" +
                $"&response_mode=query";

            Console.WriteLine($"Redirecting to: {authorizationUrl}");

            // Redirect to the identity server
            Navigation.NavigateTo(authorizationUrl, forceLoad: true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in HandleLogin: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            Navigation.NavigateTo("/");
        }
    }

    private async Task HandleLoginCallback()
    {
        Console.WriteLine("Handling login callback...");
        Console.WriteLine($"Code: {Code}");
        Console.WriteLine($"State: {State}");

        if (!string.IsNullOrEmpty(Error))
        {
            Console.WriteLine($"Error: {Error}");
            Console.WriteLine($"Error Description: {ErrorDescription}");
            Navigation.NavigateTo("/");
            return;
        }

        if (string.IsNullOrEmpty(Code) || string.IsNullOrEmpty(State))
        {
            Console.WriteLine("Code or State is missing");
            Navigation.NavigateTo("/");
            return;
        }

        try
        {
            // Get the stored state and code verifier
            var storedState = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "state");
            var codeVerifier = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "codeVerifier");

            Console.WriteLine($"Stored State: {storedState}");

            if (storedState != State)
            {
                Console.WriteLine("State mismatch");
                Navigation.NavigateTo("/");
                return;
            }

            // For now, just redirect to the home page
            // In a real implementation, you would exchange the code for tokens
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in HandleLoginCallback: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            Navigation.NavigateTo("/");
        }
    }

    private async Task HandleLogout()
    {
        Console.WriteLine("Handling logout...");

        try
        {
            // Clear session storage
            await JSRuntime.InvokeVoidAsync("sessionStorage.clear");

            // Redirect to the home page
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in HandleLogout: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            Navigation.NavigateTo("/");
        }
    }

    private async Task HandleLogoutCallback()
    {
        Console.WriteLine("Handling logout callback...");

        try
        {
            // Clear session storage
            await JSRuntime.InvokeVoidAsync("sessionStorage.clear");

            // Redirect to the home page
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in HandleLogoutCallback: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            Navigation.NavigateTo("/");
        }
    }

    private string GenerateCodeVerifier()
    {
        var bytes = new byte[32];
        using (var rng = System.Security.Cryptography.RandomNumberGenerator.Create())
        {
            rng.GetBytes(bytes);
        }
        return Convert.ToBase64String(bytes)
            .TrimEnd('=')
            .Replace('+', '-')
            .Replace('/', '_');
    }

    private string GenerateCodeChallenge(string codeVerifier)
    {
        using (var sha256 = System.Security.Cryptography.SHA256.Create())
        {
            var challengeBytes = sha256.ComputeHash(System.Text.Encoding.UTF8.GetBytes(codeVerifier));
            return Convert.ToBase64String(challengeBytes)
                .TrimEnd('=')
                .Replace('+', '-')
                .Replace('/', '_');
        }
    }
}
