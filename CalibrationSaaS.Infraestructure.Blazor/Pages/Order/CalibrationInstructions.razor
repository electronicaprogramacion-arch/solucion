@using CalibrationSaaS.Domain.Aggregates.Shared
@using CalibrationSaaS.Domain.Aggregates.Shared.Basic
@using Blazed.Controls
@using CalibrationSaaS.Application.Services
@using CalibrationSaaS.Domain.Aggregates.Querys;
@using CalibrationSaaS.Infraestructure.Blazor.Pages.Basics.TestPoints;
@using CalibrationSaaS.Infraestructure.Blazor.Pages.Basics;
@using DynamicExpressions;
@using System;
@using System.Linq;
@using System.Collections.Generic;
@using Microsoft.AspNetCore.Components.Web;
@using CalibrationSaaS.Infraestructure.Blazor.Pages.Base;
@using Blazored.Modal;
@using Blazored.Modal.Services;
@using System.Runtime.CompilerServices;

@inherits CalibrationInstructionsBase;
@inject ILogger<CalibrationInstructions> Logger


@if (@editContext != null && CurrentStatus != null && AppStateBasics.ToleranceList2 != null
&& eq.PieceOfEquipment != null && eq.PieceOfEquipment.EquipmentTemplate != null)
{
    <EditForm EditContext="@editContext">
        <DataAnnotationsValidator />

       
        <div class="form-row">
            <div class="col-sm">
                @if (CurrentStatus != null && eq != null)
                {
                    //Console.WriteLine("this is change");
                    //Console.WriteLine(eq.CurrentStatus.StatusId);
                    //Console.WriteLine(CurrentStatus.StatusId);

                    <MultiComponent Instance="eq" Policy="@UsersAccess" TTYPE="WorkOrderDetail">
                        <Rules>
                            <Rule LambdaCondition="@(Querys.WODRules.RuleContractReviewStatus().Compile())" TTYPE="WorkOrderDetail">

                            </Rule>
                            <RulesTemplate TValue="int?"
                                           TTYPE="WorkOrderDetail" Context="Entity">
                                <ValidConditionsTemplate>
                                    <TextInput @bind-Value="@Entity.TechnicianID" ValidationFor="@(() => Entity.TechnicianID)"
                                               Validate="false" Label="Assigned Technician">
                                        @if (Entity.WorkOder != null && Entity.WorkOder.UserWorkOrders != null)
                                        {
                                            @foreach (var item in Entity.WorkOder.UserWorkOrders)
                                            {
                                                string name = item.User.Name + " " + @item?.User?.LastName;


                                                <option value="@item.User.UserID">@name </option>
                                            }



                                        }
                                        else
                                        {
                                            ShowTech = true;
                                        }
                                    </TextInput>
                                </ValidConditionsTemplate>
                                <InvalidConditionsTemplate>
                                    <TextInput @bind-Value="@Entity.TechnicianID" ValidationFor="@(() => Entity.TechnicianID)" Type="@Types.ReadOnlySelect" Label="Assigned Technician">
                                        @if (Entity.WorkOder != null && Entity.WorkOder.UserWorkOrders != null)
                                        {
                                            @foreach (var item in Entity.WorkOder.UserWorkOrders)
                                            {
                                                string name = item.User.Name + " " + @item.User.LastName;


                                                <option value="@item.User.UserID">@name </option>
                                            }
                                        }
                                    </TextInput>
                                </InvalidConditionsTemplate>

                            </RulesTemplate>
                        </Rules>
                    </MultiComponent>

                }
            </div>
            <div class="col-md">

                <MultiComponent Instance="eq" Policy="@UsersAccess" TTYPE="WorkOrderDetail">
                    <Rules>
                        <Rule LambdaCondition="@(Querys.WODRules.RuleContractReviewStatus().Compile())" TTYPE="WorkOrderDetail">
                            <div> la regla no se cumple</div>
                        </Rule>
                        <RulesTemplate TValue="int"
                                       TTYPE="WorkOrderDetail" Context="Entity">

                            <ValidConditionsTemplate>

                                <TextInput @bind-Value="@Entity.CalibrationIntervalID" OnChangeControl="ChangeList" Label="Calibration Interval">

                                    @foreach (KeyValuePair<int, string> item in AppState.CalibrationInterval)
                                    {

                                        <option value="@item.Key">@item.Value</option>

                                    }
                                </TextInput>


                            </ValidConditionsTemplate>
                            <InvalidConditionsTemplate>
                                <TextInput @bind-Value="@Entity.CalibrationIntervalID" Type="@Types.ReadOnlySelect" Label="Calibration Interval">

                                    @foreach (KeyValuePair<int, string> item in AppState.CalibrationInterval)
                                    {

                                        <option value="@item.Key">@item.Value</option>

                                    }
                                </TextInput>

                            </InvalidConditionsTemplate>


                        </RulesTemplate>



                    </Rules>
                </MultiComponent>
            </div>
            <div class="col-md">

                <MultiComponent Instance="eq" Policy="@UsersAccess" TTYPE="WorkOrderDetail">
                    <Rules>
                        <Rule LambdaCondition="@(Querys.WODRules.RuleContractReviewStatus().Compile())" TTYPE="WorkOrderDetail">

                        </Rule>
                        <RulesTemplate TValue="DateTime"
                                       TTYPE="WorkOrderDetail"
                                       Context="Entity">


                            <ValidConditionsTemplate>
                                <TextInput TValue="DateTime?"
                                           Type=@Types.datetime
                                           @bind-Value="@eq.CalibrationDate" OnChangeControl="ChangeDate"
                                           ValidationFor="@(() => eq.CalibrationDate)"
                                           Label="Calibration Date">
                                </TextInput>
                            </ValidConditionsTemplate>
                            <InvalidConditionsTemplate>
                                <TextInput TValue="DateTime?"
                                           Type=@Types.datetime
                                           @bind-Value="@eq.CalibrationDate"
                                           IsDisabled="true"
                                           ValidationFor="@(() => eq.CalibrationDate)"
                                           Label="Calibration Date">
                                </TextInput>
                            </InvalidConditionsTemplate>
                        </RulesTemplate>
                    </Rules>
                </MultiComponent>

                @BoundValue(eq)

            </div>
            <div class="col-md">

                <MultiComponent Instance="eq" Policy="@UsersAccess" TTYPE="WorkOrderDetail">
                    <Rules>
                        <Rule LambdaCondition="@(Querys.WODRules.RuleContractReviewCustomDateStatus(Custom).Compile())" TTYPE="WorkOrderDetail">
                            <div> la regla no se cumple</div>
                        </Rule>
                        <RulesTemplate TValue="DateTime"
                                       TTYPE="WorkOrderDetail"
                                       Context="Entity">

                            <ValidConditionsTemplate>
                                <TextInput TValue="DateTime?"
                                           Label="Due Date"
                                           Type=@Types.datetime
                                           IsDisabled="false"
                                           @bind-Value="@eq.CalibrationCustomDueDate"
                                           ValidationFor="@(() => eq.CalibrationCustomDueDate)">
                                </TextInput>
                            </ValidConditionsTemplate>
                            <InvalidConditionsTemplate>
                                <TextInput TValue="DateTime?"
                                           Label="Due Date"
                                           Type=@Types.datetime
                                           IsDisabled="true"
                                           @bind-Value="@eq.CalibrationCustomDueDate"
                                           ValidationFor="@(() => eq.CalibrationCustomDueDate)">
                                </TextInput>
                            </InvalidConditionsTemplate>

                        </RulesTemplate>
                    </Rules>
                </MultiComponent>
            </div>


            @*@if (Custom)*@
            @if (1 == 2)
            {
                <div class="form-row">

                    <div class="col-md">
                        @*<label for="inputCity">Next Due Date</label>*@

                        <MultiComponent Instance="eq" Policy="@UsersAccess" TTYPE="WorkOrderDetail">
                            <Rules>
                                <Rule LambdaCondition="@(Querys.WODRules.RuleContractReviewStatus().Compile())" TTYPE="WorkOrderDetail">
                                    <div> la regla no se cumple</div>
                                </Rule>
                                <RulesTemplate TValue="DateTime"
                                               TTYPE="WorkOrderDetail"
                                               Context="Entity">

                                    <ValidConditionsTemplate>
                                        <TextInput TValue="DateTime?"
                                                   Label="Next Due Date"
                                                   Type=@Types.datetime
                                                   @bind-Value="@eq.CalibrationNextDueDate"
                                                   ValidationFor="@(() => eq.CalibrationNextDueDate)">
                                        </TextInput>
                                    </ValidConditionsTemplate>

                                    <InvalidConditionsTemplate>
                                        <TextInput TValue="DateTime?"
                                                   Label="Next Due Date"
                                                   Type=@Types.datetime
                                                   IsDisabled="true"
                                                   @bind-Value="@eq.CalibrationNextDueDate"
                                                   ValidationFor="@(() => eq.CalibrationNextDueDate)">
                                        </TextInput>
                                    </InvalidConditionsTemplate>
                                </RulesTemplate>
                            </Rules>
                        </MultiComponent>
                    </div>
                </div>
            }

        </div>
        <div class="row" style="min-height:10px">

        </div>
        <div class="row">

            <div class="col">

                @*@if (eq.IsAccredited.HasValue && eq.IsAccredited.Value)
                    {

                        <TextInput @bind-Value="eq.IsAccredited"
                                   IsDisabled="!Enabled"
                                   Label="Is Accredited?"
                                   LabelDown="@LabelDown"
                                   ValidationFor="(()=> eq.IsAccredited)"
                                   Type="@Types.Switch" OnChangeObjectControl="ChangeSwitch">

                        </TextInput>


                    }
                    else
                    {

                        <TextInput @bind-Value="eq.IsAccredited"
                                   IsDisabled="!Enabled"
                                   Label="Is Accredited?"
                                   LabelDown="@LabelDown"
                                   ValidationFor="(()=> eq.IsAccredited)"
                                   Type="@Types.Switch" OnChangeObjectControl="ChangeSwitch">

                        </TextInput>
                    }*@

                @{
                    //var predicate = DynamicExpressions.GetPredicate<WorkOrderDetail>("", FilterOperator.Equals, 1);
                }
                <MultiComponent Instance="eq" Policy="@UsersAccess" TTYPE="WorkOrderDetail">
                    <Rules>
                        <Rule LambdaCondition="@(Querys.WODRules.RuleIsAccreditedStatus().Compile())" TTYPE="WorkOrderDetail">
                            <div> la regla no se cumple</div>
                        </Rule>
                        @*<Rule LambdaCondition="@(x=>x.IsAccredited.HasValue && x.IsAccredited.Value)" TTYPE="WorkOrderDetail">
                                <div> la regla no se cumple</div>
                            </Rule>*@
                        <RulesTemplate TValue="DateTime"
                                       TTYPE="WorkOrderDetail"
                                       Context="Entity">
                            <ValidConditionsTemplate>
                                @if (eq.CurrentStatusID <= 2)
                                {
                                    <TextInput @bind-Value="eq.IsAccredited"
                                    IsDisabled="false"
                                    Label="Is Accredited?"
                                    LabelDown="@LabelDown"
                                    ValidationFor="(()=> eq.IsAccredited)"
                                    Type="@Types.Switch" OnChangeObjectControl="ChangeSwitch">

                                    </TextInput>
                                }
                                else
                                {
                                    <TextInput @bind-Value="eq.IsAccredited"
                                               IsDisabled="true"
                                               Label="Is Accredited?"
                                               LabelDown="@LabelDown"
                                               ValidationFor="(()=> eq.IsAccredited)"
                                               Type="@Types.Switch" OnChangeObjectControl="ChangeSwitch">

                                    </TextInput>
                                }
                            </ValidConditionsTemplate>

                            <InvalidConditionsTemplate>
                                <TextInput @bind-Value="eq.IsAccredited"
                                           IsDisabled="true"
                                           Label="Is Accredited?"
                                           LabelDown="@LabelDown"
                                           ValidationFor="(()=> eq.IsAccredited)"
                                           Type="@Types.Switch" OnChangeObjectControl="ChangeSwitch">

                                </TextInput>
                            </InvalidConditionsTemplate>
                        </RulesTemplate>
                    </Rules>
                </MultiComponent>

                 <MultiComponent Instance="eq" Policy="@UsersAccess" TTYPE="WorkOrderDetail">
                    <Rules>
                        <Rule LambdaCondition="@(Querys.WODRules.RuleContractReviewStatus().Compile())" TTYPE="WorkOrderDetail">
                            <div> la regla no se cumple</div>
                        </Rule>
                        @*<Rule LambdaCondition="@(x=>x.IsAccredited.HasValue && x.IsAccredited.Value)" TTYPE="WorkOrderDetail">
                                <div> la regla no se cumple</div>
                            </Rule>*@
                        <RulesTemplate TValue="Boolean"
                                       TTYPE="WorkOrderDetail"
                                       Context="Entity">
                            <ValidConditionsTemplate>
                                <TextInput @bind-Value="eq.EndOfMonth"
                                           IsDisabled="false"
                                           Label="End Of Month"
                                           LabelDown="@LabelDown"
                                           ValidationFor="(()=> eq.EndOfMonth)"
                                           Type="@Types.Switch" OnChangeObjectControl="ChangeSwitchEndOfMonth">

                                </TextInput>
                            </ValidConditionsTemplate>

                            <InvalidConditionsTemplate>
                                <TextInput @bind-Value="eq.EndOfMonth"
                                           IsDisabled="true"
                                           Label="End Of Month"
                                           LabelDown="@LabelDown"
                                           ValidationFor="(()=> eq.EndOfMonth)"
                                           Type="@Types.Switch" OnChangeObjectControl="ChangeSwitch">

                                </TextInput>
                            </InvalidConditionsTemplate>
                        </RulesTemplate>
                    </Rules>
                </MultiComponent>

                 <MultiComponent Instance="eq" Policy="@UsersAccess" TTYPE="WorkOrderDetail">
                    <Rules>
                        <Rule LambdaCondition="@(Querys.WODRules.RuleIsAccreditedStatus().Compile())" TTYPE="WorkOrderDetail">
                            <div> la regla no se cumple</div>
                        </Rule>
                        @*<Rule LambdaCondition="@(x=>x.IsAccredited.HasValue && x.IsAccredited.Value)" TTYPE="WorkOrderDetail">
                                <div> la regla no se cumple</div>
                            </Rule>*@
                        <RulesTemplate TValue="Boolean"
                                       TTYPE="WorkOrderDetail"
                                       Context="Entity">
                            <ValidConditionsTemplate>
                                @if(eq.CurrentStatusID <=2)
                                {
                                <TextInput @bind-Value="eq.IsAccredited"
                                           IsDisabled="false"
                                           Label="Is Accredited"
                                           LabelDown="@LabelDown"
                                           ValidationFor="(()=> eq.IsAccredited)"
                                           Type="@Types.Switch" 
                                           >

                                    </TextInput>
                                }
                                else
                                {
                                    <TextInput @bind-Value="eq.IsAccredited"
                                               IsDisabled="true"
                                               Label="Is Accredited"
                                               LabelDown="@LabelDown"
                                               ValidationFor="(()=> eq.IsAccredited)"
                                               Type="@Types.Switch">

                                    </TextInput>
                                }
                            </ValidConditionsTemplate>

                            @* <InvalidConditionsTemplate>
                                <TextInput @bind-Value="eq.IsAccredited"
                                           IsDisabled="true"
                                           Label="Is Accredited"
                                           LabelDown="@LabelDown"
                                           ValidationFor="(()=> eq.IsAccredited)"
                                           Type="@Types.Switch" 
                                           >

                                </TextInput>
                            </InvalidConditionsTemplate> *@
                        </RulesTemplate>
                    </Rules>
                </MultiComponent>

            </div>
            
            <div class="col">

                <MultiComponent Instance="eq" Policy="@UsersAccess" TTYPE="WorkOrderDetail">
                    <Rules>
                        <Rule LambdaCondition="@(Querys.WODRules.RuleContractReviewStatus().Compile())" TTYPE="WorkOrderDetail">
                            <div> la regla no se cumple</div>
                        </Rule>
                        <RulesTemplate TValue="DateTime"
                                       TTYPE="WorkOrderDetail"
                                       Context="Entity">

                            <ValidConditionsTemplate>

                                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal1">
                                    Tolerance Information
                                </button>
                            </ValidConditionsTemplate>
                            <InvalidConditionsTemplate>

                                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal1">
                                    Tolerance Information
                                </button>
                            </InvalidConditionsTemplate>
                        </RulesTemplate>
                    </Rules>
                </MultiComponent>
            </div>
            @if (eq.ToleranceTypeID == 3 && Customer == "Bitterman")
            {


                <div class="col-sm-4">
                    <TextInput @bind-Value="eq.IsComercial"
                               IsDisabled="!Enabled"
                               Label="Commercial?"
                               LabelDown="@LabelDown"
                               ValidationFor="(()=> eq.IsComercial)"
                               Type="@Types.Switch"
                               OnChangeObjectControl="ChangeSwitch">

                    </TextInput>

                </div>

                @if (!eq.IsComercial)
                {
                    <div class="col-sm-4">
                        <TextInput @bind-Value="eq.Multiplier"
                                   IsDisabled="!Enabled"
                                   Label="Multiplier"
                                   LabelDown="@LabelDown"
                                   ValidationFor="(()=> eq.Multiplier)"
                                   Type="@Types.number">

                        </TextInput>

                    </div>
                }


            }
        </div>
        <div class="center">
            <div class="modal fade bd-example-modal-lg" id="exampleModal1" data-backdrop="true" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog  modal-lg"  role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Resolution</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close" @onclick="@(async () => await CloseWindow())"
                                    @onclick:stopPropagation @onclick:preventDefault>
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            @if (eq != null)
                            {
                                <CascadingValue Value="@WorkOrderItemCreate.eq.Tolerance" Name="CascadeTolerance">
                                <MultiComponent Instance="eq" Policy="@UsersAccess" TTYPE="WorkOrderDetail">
                                    <Rules>
                                        <Rule LambdaCondition="@(Querys.WODRules.RuleContractReviewStatus().Compile())" TTYPE="WorkOrderDetail">
                                            <div> la regla no se cumple</div>
                                        </Rule>
                                        <RulesTemplate TValue="DateTime"
                                                       TTYPE="WorkOrderDetail"
                                                       Context="Entity">
                                            <ValidConditionsTemplate>
                                                
                                                <ResolutionComponent 
                                                                     @ref="@ResolutionComponent" 
                                                                     Title="Resolution Component" 
                                                                     Type="1" 
                                                                     IsWOD="true" 
                                                                     Enabled="true" 
                                                                     Refresh="Refresh"
                                                                     ToleranceList="AppState.ToleranceList2.Where(x=>WorkOrderItemCreate.eq.CalibrationTypeID > 0 && x.CalibrationTypeId==WorkOrderItemCreate.eq.CalibrationTypeID)">
                                                </ResolutionComponent>


                                              
                                            </ValidConditionsTemplate>
                                            <InvalidConditionsTemplate>
                                                    <ResolutionComponent @ref="@ResolutionComponent"
                                                                         Title="Resolution Component"
                                                                         Type="1"
                                                                         IsWOD="true"
                                                                         Enabled="false"
                                                                         Refresh="Refresh"
                                                                         ToleranceList="AppState.ToleranceList2.Where(x=>WorkOrderItemCreate.eq.CalibrationTypeID > 0 && x.CalibrationTypeId==WorkOrderItemCreate.eq.CalibrationTypeID)">
                                                    </ResolutionComponent>

                                            </InvalidConditionsTemplate>
                                        </RulesTemplate>
                                    </Rules>
                                </MultiComponent>
                                </CascadingValue>
                            }
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal" @onclick="@(async () => await CloseWindow())"
                                    @onclick:stopPropagation @onclick:preventDefault>
                                Close
                            </button>
                            @*<button type="button" class="btn btn-primary">Save changes</button>*@
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </EditForm>
}
@code {

async Task Refresh()
        {



        } 



}
