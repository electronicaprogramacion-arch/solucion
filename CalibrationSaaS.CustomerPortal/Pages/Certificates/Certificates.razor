@page "/{tenant}/certificates"
@layout MainLayout
@implements IDisposable
@using CalibrationSaaS.CustomerPortal.Models.Certificates
@using CalibrationSaaS.CustomerPortal.Services.Certificates
@using CalibrationSaaS.CustomerPortal.Services.GrpcClients
@using Microsoft.AspNetCore.Components.Authorization
@using Radzen
@using Radzen.Blazor
@inject ICertificateService CertificateService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NotificationService NotificationService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject ILogger<Certificates> Logger

<PageTitle>Certificates - CalibrationSaaS Customer Portal</PageTitle>

<header class="stitch-header">
    <h1>Certificates</h1>
    <p style="margin-top: 5px; margin-left: 16px;">Search, filter, and download your calibration certificates.</p>
</header>

<section class="stitch-section">
    <div class="stitch-search-header">
        <div class="stitch-search-controls">
            <div class="stitch-search-field">
                <input @bind="searchText" @oninput="@((args) => OnSearchChanged(args.Value?.ToString()))"
                       class="stitch-input"
                       placeholder="Search by equipment, work order, or certificate..." />
            </div>
            <div class="stitch-filter-controls">
                <select @bind="selectedStatus" @bind:after="OnFilterChanged" class="stitch-select">
                    <option value="">All Statuses</option>
                    @foreach (var status in statusOptions)
                    {
                        <option value="@status.Value">@status.Text</option>
                    }
                </select>
                <input type="date" @bind="dateFrom" @bind:after="OnFilterChanged" class="stitch-input" />
                <input type="date" @bind="dateTo" @bind:after="OnFilterChanged" class="stitch-input" />
                <button @onclick="ExportAllCertificates" disabled="@(!certificates?.Any() == true)" class="stitch-btn-primary">
                    Download Selected
                </button>
            </div>
        </div>
    </div>

    <div class="stitch-table-container">
        @if (isLoading)
        {
            <div class="stitch-loading">
                <p>Loading certificates...</p>
            </div>
        }
        else if (certificates?.Any() == true)
        {
            <table class="stitch-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" /></th>
                        <th>Equipment</th>
                        <th>Work Order</th>
                        <th>Certificate #</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var certificate in certificates.Take(pageSize))
                    {
                        <tr>
                            <td><input type="checkbox" /></td>
                            <td>
                                <div class="stitch-cell-primary">@certificate.Equipment?.Description</div>
                                <div class="stitch-cell-secondary">SN: @certificate.Equipment?.SerialNumber</div>
                            </td>
                            <td>@certificate.WorkOrderNumber</td>
                            <td>
                                <button @onclick="@(() => OnCertificateSelected(certificate))" class="stitch-link">
                                    @certificate.CertificateNumber
                                </button>
                            </td>
                            <td>@certificate.IssueDate.ToString("yyyy-MM-dd")</td>
                            <td>
                                <span class="stitch-status @GetStatusClasses(certificate.Status)">
                                    @certificate.Status
                                </span>
                            </td>
                            <td>
                                <button @onclick="@(() => DownloadCertificate(certificate.Id))"
                                        class="stitch-btn-secondary"
                                        disabled="@(certificate.Status != "Completed")">
                                    Download
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="stitch-empty-state">
                <h3>No Certificates Found</h3>
                <p>
                    @if (string.IsNullOrEmpty(searchText))
                    {
                        <text>No certificates are available for your account.</text>
                    }
                    else
                    {
                        <text>No certificates match your search criteria. Try adjusting your filters.</text>
                    }
                </p>
            </div>
        }
    </div>
</section>





@code {
    [Parameter] public string? tenant { get; set; }

    private List<Models.Certificates.CertificateDto>? certificates;
    private Models.Certificates.CertificateDto? selectedCertificate;

    private bool isLoading = false;
    private string searchText = "";
    private string? selectedStatus;
    private DateTime? dateFrom;
    private DateTime? dateTo;
    private string viewMode = "list";
    private int currentPage = 1;
    private int pageSize = 12;
    private int totalCount = 0;

    private readonly List<StatusOption> statusOptions = new()
    {
        new StatusOption { Text = "Issued", Value = "Issued" },
        new StatusOption { Text = "Draft", Value = "Draft" },
        new StatusOption { Text = "Pending", Value = "Pending" },
        new StatusOption { Text = "Cancelled", Value = "Cancelled" },
        new StatusOption { Text = "Expired", Value = "Expired" }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadCertificates();
    }

    private async Task LoadCertificates()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                var customerId = authState.User.GetCustomerId();
                var tenantId = authState.User.GetTenantId();
                if (customerId.HasValue)
                {
                    var searchRequest = new CertificateSearchRequest
                    {
                        Page = currentPage,
                        PageSize = viewMode == "list" ? 10 : pageSize,
                        SearchText = searchText,
                        Status = selectedStatus,
                        DateFrom = dateFrom,
                        DateTo = dateTo,
                        SortBy = "IssueDate",
                        SortDirection = "desc",
                        TenantId = tenantId ?? tenant
                    };

                    // Demo: Use mock certificates for demo purposes
                    certificates = GetMockCertificates();
                    totalCount = certificates.Count;
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading certificates");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error Loading Certificates",
                Detail = "Unable to load certificates. Please try again.",
                Duration = 5000
            });
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnSearchChanged(string? value)
    {
        searchText = value ?? "";
        currentPage = 1;
        await LoadCertificates();
    }

    private async Task OnFilterChanged()
    {
        currentPage = 1;
        await LoadCertificates();
    }

    private async Task OnPageChanged(int page)
    {
        currentPage = page;
        await LoadCertificates();
    }

    private void OnCertificateSelected(Models.Certificates.CertificateDto certificate)
    {
        selectedCertificate = certificate;
        // Navigate to certificate detail page
        Navigation.NavigateTo($"/{tenant}/certificates/{certificate.Id}");
    }

    private async Task SetViewMode(string mode)
    {
        viewMode = mode;
        currentPage = 1;
        await LoadCertificates();
    }

    private async Task DownloadCertificate(int certificateId)
    {
        try
        {
            Logger.LogInformation("ðŸŽ¬ DEMO MODE: Starting certificate download for certificate {CertificateId}", certificateId);

            // Demo: Use the existing DownloadController endpoint instead of JavaScript eval
            var downloadUrl = $"/api/download/certificate/{certificateId}";

            Logger.LogInformation("ðŸ”— Opening download URL: {DownloadUrl}", downloadUrl);

            // Use window.open to download in new tab (CSP-safe approach)
            await JSRuntime.InvokeVoidAsync("open", downloadUrl, "_blank");

            Logger.LogInformation("âœ… Demo certificate download initiated for certificate {CertificateId}", certificateId);

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Download Started",
                Detail = "Certificate download has been initiated in a new tab.",
                Duration = 3000
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "âŒ Error downloading certificate {CertificateId}", certificateId);

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Download Failed",
                Detail = "An error occurred while downloading the certificate. Please try again.",
                Duration = 5000
            });
        }
    }

    private async Task ExportAllCertificates()
    {
        try
        {
            // Implementation for bulk export
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Info,
                Summary = "Export Started",
                Detail = "Preparing certificates for export...",
                Duration = 3000
            });
            await Task.CompletedTask;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error exporting certificates");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Export Error",
                Detail = "Unable to export certificates. Please try again.",
                Duration = 5000
            });
        }
    }

    private void ViewCertificateDetails(int certificateId)
    {
        // Navigate to detailed certificate view
        // Navigation.NavigateTo($"/certificates/{certificateId}");
    }

    private BadgeStyle GetStatusBadgeStyle(string? status)
    {
        return status?.ToLower() switch
        {
            "issued" => BadgeStyle.Success,
            "draft" => BadgeStyle.Secondary,
            "pending" => BadgeStyle.Warning,
            "cancelled" => BadgeStyle.Danger,
            "expired" => BadgeStyle.Light,
            _ => BadgeStyle.Info
        };
    }

    private string GetStatusClasses(string? status)
    {
        return status?.ToLower() switch
        {
            "completed" => "bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400",
            "issued" => "bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400",
            "draft" => "bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-400",
            "pending" => "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400",
            "cancelled" => "bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400",
            "expired" => "bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-400",
            _ => "bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400"
        };
    }

    private string GetStatusDotColor(string? status)
    {
        return status?.ToLower() switch
        {
            "completed" => "text-green-400",
            "issued" => "text-green-400",
            "draft" => "text-gray-400",
            "pending" => "text-yellow-400",
            "cancelled" => "text-red-400",
            "expired" => "text-gray-400",
            _ => "text-blue-400"
        };
    }

    private class StatusOption
    {
        public string Text { get; set; } = "";
        public string Value { get; set; } = "";
    }

    /// <summary>
    /// Demo: Returns mock certificates for demo purposes
    /// </summary>
    private List<Models.Certificates.CertificateDto> GetMockCertificates()
    {
        return new List<Models.Certificates.CertificateDto>
        {
            new Models.Certificates.CertificateDto
            {
                Id = 1001,
                CertificateNumber = "CERT-2024-001",
                WorkOrderNumber = "WO-2024-001",
                IssueDate = DateTime.Now.AddDays(-5),
                Status = "Completed",
                Equipment = new Models.Certificates.EquipmentDto
                {
                    Id = 101,
                    SerialNumber = "TH-001-2023",
                    Description = "Digital Thermometer",
                    Manufacturer = "Fluke",
                    Model = "1523",
                    Location = "Lab A",
                    NextCalibrationDate = DateTime.Now.AddMonths(12)
                },
                Customer = new Models.Certificates.CustomerDto
                {
                    Id = 1,
                    Name = "Kavoku",
                    ContactPerson = "Javier Pardo",
                    Email = "jpardo@kavoku.com"
                }
            },
            new Models.Certificates.CertificateDto
            {
                Id = 1002,
                CertificateNumber = "CERT-2024-002",
                WorkOrderNumber = "WO-2024-002",
                IssueDate = DateTime.Now.AddDays(-10),
                Status = "Completed",
                Equipment = new Models.Certificates.EquipmentDto
                {
                    Id = 102,
                    SerialNumber = "PR-002-2023",
                    Description = "Pressure Gauge",
                    Manufacturer = "Ashcroft",
                    Model = "1009",
                    Location = "Lab B",
                    NextCalibrationDate = DateTime.Now.AddMonths(12)
                },
                Customer = new Models.Certificates.CustomerDto
                {
                    Id = 1,
                    Name = "Kavoku",
                    ContactPerson = "Javier Pardo",
                    Email = "jpardo@kavoku.com"
                }
            },
            new Models.Certificates.CertificateDto
            {
                Id = 1003,
                CertificateNumber = "CERT-2024-003",
                WorkOrderNumber = "WO-2024-003",
                IssueDate = DateTime.Now.AddDays(-15),
                Status = "Completed",
                Equipment = new Models.Certificates.EquipmentDto
                {
                    Id = 103,
                    SerialNumber = "SC-003-2023",
                    Description = "Analytical Scale",
                    Manufacturer = "Mettler Toledo",
                    Model = "XS205",
                    Location = "QC Lab",
                    NextCalibrationDate = DateTime.Now.AddMonths(6)
                },
                Customer = new Models.Certificates.CustomerDto
                {
                    Id = 1,
                    Name = "Kavoku",
                    ContactPerson = "Javier Pardo",
                    Email = "jpardo@kavoku.com"
                }
            },
            new Models.Certificates.CertificateDto
            {
                Id = 1004,
                CertificateNumber = "CERT-2024-004",
                WorkOrderNumber = "WO-2024-004",
                IssueDate = DateTime.Now.AddDays(-20),
                Status = "Completed",
                Equipment = new Models.Certificates.EquipmentDto
                {
                    Id = 104,
                    SerialNumber = "VM-004-2023",
                    Description = "Digital Voltmeter",
                    Manufacturer = "Keysight",
                    Model = "34461A",
                    Location = "Electronics Lab",
                    NextCalibrationDate = DateTime.Now.AddMonths(12)
                },
                Customer = new Models.Certificates.CustomerDto
                {
                    Id = 1,
                    Name = "Kavoku",
                    ContactPerson = "Javier Pardo",
                    Email = "jpardo@kavoku.com"
                }
            },
            new Models.Certificates.CertificateDto
            {
                Id = 1005,
                CertificateNumber = "CERT-2024-005",
                WorkOrderNumber = "WO-2024-005",
                IssueDate = DateTime.Now.AddDays(-25),
                Status = "Completed",
                Equipment = new Models.Certificates.EquipmentDto
                {
                    Id = 105,
                    SerialNumber = "FL-005-2023",
                    Description = "Flow Meter",
                    Manufacturer = "Endress+Hauser",
                    Model = "Proline 300",
                    Location = "Process Lab",
                    NextCalibrationDate = DateTime.Now.AddMonths(12)
                },
                Customer = new Models.Certificates.CustomerDto
                {
                    Id = 1,
                    Name = "Kavoku",
                    ContactPerson = "Javier Pardo",
                    Email = "jpardo@kavoku.com"
                }
            }
        };
    }

    public void Dispose()
    {
        // Cleanup if needed
    }
}
