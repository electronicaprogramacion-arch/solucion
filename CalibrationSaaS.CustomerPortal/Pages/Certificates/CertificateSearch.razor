@page "/certificates/search"
@using CalibrationSaaS.CustomerPortal.Models.Certificates
@using CalibrationSaaS.CustomerPortal.Models.ViewModels
@using CalibrationSaaS.CustomerPortal.Services.Certificates
@inject ICertificateService CertificateService
@inject IJSRuntime JSRuntime
@inject ILogger<CertificateSearch> Logger

<PageTitle>Certificate Search - Customer Portal</PageTitle>

<RadzenStack Gap="1rem">
    <!-- Page Header -->
    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenCard>
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                        <RadzenIcon Icon="description" Style="font-size: 2rem; color: var(--rz-primary);" />
                        <RadzenStack Gap="0.25rem">
                            <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H1" Class="rz-mb-0">
                                Certificate Search
                            </RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2" Class="rz-color-secondary">
                                Search and manage your calibration certificates
                            </RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                    
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                        <RadzenButton Icon="refresh" Text="Refresh" Click="@RefreshSearch" Variant="Variant.Text" />
                        <RadzenButton Icon="download" Text="Export" Click="@ExportResults" Variant="Variant.Outlined" 
                                    Disabled="@(!ViewModel.Certificates.Any())" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <!-- Quick Filters -->
    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenCard>
                <RadzenStack Gap="1rem">
                    <RadzenText TextStyle="TextStyle.Subtitle1">Quick Filters</RadzenText>
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap">
                        <RadzenButton Text="All Certificates" Click="@(() => ApplyQuickFilter(""))" 
                                    Variant="@(string.IsNullOrEmpty(_activeQuickFilter) ? Variant.Filled : Variant.Outlined)" 
                                    Size="ButtonSize.Small" />
                        <RadzenButton Text="Recent (30 days)" Click="@(() => ApplyQuickFilter("recent"))" 
                                    Variant="@(_activeQuickFilter == "recent" ? Variant.Filled : Variant.Outlined)" 
                                    Size="ButtonSize.Small" />
                        <RadzenButton Text="Expiring Soon" Click="@(() => ApplyQuickFilter("expiring"))" 
                                    Variant="@(_activeQuickFilter == "expiring" ? Variant.Filled : Variant.Outlined)" 
                                    Size="ButtonSize.Small" />
                        <RadzenButton Text="Overdue" Click="@(() => ApplyQuickFilter("overdue"))" 
                                    Variant="@(_activeQuickFilter == "overdue" ? Variant.Filled : Variant.Outlined)" 
                                    Size="ButtonSize.Small" />
                        <RadzenButton Text="Compliant" Click="@(() => ApplyQuickFilter("compliant"))" 
                                    Variant="@(_activeQuickFilter == "compliant" ? Variant.Filled : Variant.Outlined)" 
                                    Size="ButtonSize.Small" />
                        <RadzenButton Text="Non-Compliant" Click="@(() => ApplyQuickFilter("noncompliant"))" 
                                    Variant="@(_activeQuickFilter == "noncompliant" ? Variant.Filled : Variant.Outlined)" 
                                    Size="ButtonSize.Small" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <!-- Search Filters -->
    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenCard>
                <RadzenStack Gap="1rem">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenText TextStyle="TextStyle.Subtitle1">Search Filters</RadzenText>
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            <RadzenButton Icon="@(ViewModel.ShowAdvancedFilters ? "expand_less" : "expand_more")" 
                                        Text="@(ViewModel.ShowAdvancedFilters ? "Hide Advanced" : "Show Advanced")" 
                                        Click="@ToggleAdvancedFilters" Variant="Variant.Text" Size="ButtonSize.Small" />
                            <RadzenButton Icon="clear" Text="Clear All" Click="@ClearFilters" 
                                        Variant="Variant.Text" Size="ButtonSize.Small" />
                        </RadzenStack>
                    </RadzenStack>

                    <!-- Basic Search -->
                    <RadzenRow>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Search Text" Variant="Variant.Outlined">
                                <RadzenTextBox @bind-Value="@ViewModel.SearchRequest.SearchText" 
                                             Placeholder="Certificate number, work order, equipment..." 
                                             Style="width: 100%;" />
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="3">
                            <RadzenFormField Text="Status" Variant="Variant.Outlined">
                                <RadzenDropDown @bind-Value="@ViewModel.SearchRequest.Status" 
                                              Data="@CertificateStatus.AllStatuses" 
                                              AllowClear="true" Placeholder="All Statuses" 
                                              Style="width: 100%;" />
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="3">
                            <RadzenButton Icon="search" Text="Search" Click="@PerformSearch" 
                                        IsBusy="@ViewModel.IsSearching" Style="width: 100%;" />
                        </RadzenColumn>
                    </RadzenRow>

                    <!-- Advanced Filters -->
                    @if (ViewModel.ShowAdvancedFilters)
                    {
                        <RadzenFieldset Text="Advanced Filters">
                            <RadzenRow>
                                <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                                    <RadzenFormField Text="Certificate Number" Variant="Variant.Outlined">
                                        <RadzenTextBox @bind-Value="@ViewModel.SearchRequest.CertificateNumber" 
                                                     Placeholder="Certificate number" Style="width: 100%;" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                                    <RadzenFormField Text="Work Order Number" Variant="Variant.Outlined">
                                        <RadzenTextBox @bind-Value="@ViewModel.SearchRequest.WorkOrderNumber" 
                                                     Placeholder="Work order number" Style="width: 100%;" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                                    <RadzenFormField Text="Equipment Serial" Variant="Variant.Outlined">
                                        <RadzenTextBox @bind-Value="@ViewModel.SearchRequest.EquipmentSerialNumber" 
                                                     Placeholder="Serial number" Style="width: 100%;" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                                    <RadzenFormField Text="Equipment Type" Variant="Variant.Outlined">
                                        <RadzenDropDown @bind-Value="@ViewModel.SearchRequest.EquipmentType" 
                                                      Data="@ViewModel.AvailableEquipmentTypes" 
                                                      AllowClear="true" Placeholder="All Types" 
                                                      Style="width: 100%;" />
                                    </RadzenFormField>
                                </RadzenColumn>
                            </RadzenRow>

                            <RadzenRow>
                                <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                                    <RadzenFormField Text="Manufacturer" Variant="Variant.Outlined">
                                        <RadzenDropDown @bind-Value="@ViewModel.SearchRequest.Manufacturer" 
                                                      Data="@ViewModel.AvailableManufacturers" 
                                                      AllowClear="true" Placeholder="All Manufacturers" 
                                                      Style="width: 100%;" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                                    <RadzenFormField Text="Technician" Variant="Variant.Outlined">
                                        <RadzenDropDown @bind-Value="@ViewModel.SearchRequest.TechnicianName" 
                                                      Data="@ViewModel.AvailableTechnicians" 
                                                      AllowClear="true" Placeholder="All Technicians" 
                                                      Style="width: 100%;" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                                    <RadzenFormField Text="Location" Variant="Variant.Outlined">
                                        <RadzenDropDown @bind-Value="@ViewModel.SearchRequest.Location" 
                                                      Data="@ViewModel.AvailableLocations" 
                                                      AllowClear="true" Placeholder="All Locations" 
                                                      Style="width: 100%;" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
                                    <RadzenFormField Text="Department" Variant="Variant.Outlined">
                                        <RadzenDropDown @bind-Value="@ViewModel.SearchRequest.Department" 
                                                      Data="@ViewModel.AvailableDepartments" 
                                                      AllowClear="true" Placeholder="All Departments" 
                                                      Style="width: 100%;" />
                                    </RadzenFormField>
                                </RadzenColumn>
                            </RadzenRow>

                            <RadzenRow>
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Issue Date From" Variant="Variant.Outlined">
                                        <RadzenDatePicker @bind-Value="@ViewModel.SearchRequest.IssueDateFrom" 
                                                        ShowTime="false" DateFormat="yyyy-MM-dd" 
                                                        Style="width: 100%;" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Issue Date To" Variant="Variant.Outlined">
                                        <RadzenDatePicker @bind-Value="@ViewModel.SearchRequest.IssueDateTo" 
                                                        ShowTime="false" DateFormat="yyyy-MM-dd" 
                                                        Style="width: 100%;" />
                                    </RadzenFormField>
                                </RadzenColumn>
                            </RadzenRow>

                            <RadzenRow>
                                <RadzenColumn Size="12" SizeMD="4">
                                    <RadzenFormField Text="Compliance Status" Variant="Variant.Outlined">
                                        <RadzenDropDown @bind-Value="@ViewModel.SearchRequest.IsCompliant" 
                                                      Data="@_complianceOptions" TextProperty="Text" ValueProperty="Value"
                                                      AllowClear="true" Placeholder="All" 
                                                      Style="width: 100%;" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="4">
                                    <RadzenFormField Text="Expiring Soon (Days)" Variant="Variant.Outlined">
                                        <RadzenNumeric @bind-Value="@ViewModel.SearchRequest.ExpiringSoonDays" 
                                                     Min="1" Max="365" Placeholder="Days" 
                                                     Style="width: 100%;" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="4">
                                    <RadzenFormField Text="Show Overdue Only" Variant="Variant.Outlined">
                                        <RadzenCheckBox @bind-Value="@ViewModel.SearchRequest.IsOverdue" />
                                    </RadzenFormField>
                                </RadzenColumn>
                            </RadzenRow>
                        </RadzenFieldset>
                    }
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <!-- Search Results -->
    <RadzenRow>
        <RadzenColumn Size="12">
            <RadzenCard>
                <RadzenStack Gap="1rem">
                    <!-- Results Header -->
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                            <RadzenText TextStyle="TextStyle.Subtitle1">
                                Search Results
                            </RadzenText>
                            @if (ViewModel.SearchResponse.TotalCount > 0)
                            {
                                <RadzenBadge Text="@ViewModel.SearchResponse.TotalCount.ToString()" 
                                           BadgeStyle="BadgeStyle.Info" />
                            }
                        </RadzenStack>

                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                            @if (ViewModel.SomeSelected)
                            {
                                <RadzenText TextStyle="TextStyle.Body2" Class="rz-color-secondary">
                                    @ViewModel.SelectedCount selected
                                </RadzenText>
                                <RadzenButton Icon="download" Text="Download Selected" 
                                            Click="@DownloadSelected" Size="ButtonSize.Small" />
                                <RadzenButton Icon="clear" Text="Clear Selection" 
                                            Click="@ClearSelection" Variant="Variant.Text" Size="ButtonSize.Small" />
                            }

                            <RadzenFormField Text="Page Size" Variant="Variant.Outlined">
                                <RadzenDropDown TValue="int" Value="@ViewModel.SearchRequest.PageSize"
                                              Data="@_pageSizeOptions"
                                              ValueChanged="@OnPageSizeChanged"
                                              Style="width: 80px;" />
                            </RadzenFormField>
                        </RadzenStack>
                    </RadzenStack>

                    <!-- Loading State -->
                    @if (ViewModel.IsSearching)
                    {
                        <RadzenStack AlignItems="AlignItems.Center" Gap="1rem" Style="padding: 2rem;">
                            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                            <RadzenText TextStyle="TextStyle.Body2" Class="rz-color-secondary">
                                Searching certificates...
                            </RadzenText>
                        </RadzenStack>
                    }
                    else if (!string.IsNullOrEmpty(ViewModel.SearchError))
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Danger" Icon="error" Title="Search Error">
                            @ViewModel.SearchError
                        </RadzenAlert>
                    }
                    else if (!ViewModel.Certificates.Any())
                    {
                        <RadzenStack AlignItems="AlignItems.Center" Gap="1rem" Style="padding: 2rem;">
                            <RadzenIcon Icon="search_off" Style="font-size: 3rem; color: var(--rz-text-disabled-color);" />
                            <RadzenText TextStyle="TextStyle.H6" Class="rz-color-secondary">
                                No certificates found
                            </RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2" Class="rz-color-secondary">
                                Try adjusting your search criteria or filters
                            </RadzenText>
                        </RadzenStack>
                    }
                    else
                    {
                        <!-- Results Table -->
                        <RadzenDataGrid @ref="certificatesGrid" Data="@ViewModel.Certificates" TItem="CertificateViewModel"
                                      AllowSorting="true" AllowFiltering="false" AllowPaging="false"
                                      GridLines="DataGridGridLines.Both" Style="height: 600px;">
                            <Columns>
                                <RadzenDataGridColumn TItem="CertificateViewModel" Width="50px" Sortable="false" Filterable="false">
                                    <HeaderTemplate>
                                        <RadzenCheckBox Value="@ViewModel.AllSelected"
                                                      ValueChanged="@((bool value) => ToggleSelectAll())" />
                                    </HeaderTemplate>
                                    <Template Context="certificate">
                                        <RadzenCheckBox Value="@certificate.IsSelected"
                                                      ValueChanged="@((bool value) => OnSelectionChanged(certificate, value))" />
                                    </Template>
                                </RadzenDataGridColumn>

                                <RadzenDataGridColumn TItem="CertificateViewModel" Property="Certificate.CertificateNumber"
                                                    Title="Certificate #" Width="150px">
                                    <Template Context="certificate">
                                        <RadzenLink Path="@($"/certificates/{certificate.Certificate.Id}")"
                                                  Text="@certificate.Certificate.CertificateNumber" />
                                    </Template>
                                </RadzenDataGridColumn>

                                <RadzenDataGridColumn TItem="CertificateViewModel" Property="Certificate.Equipment.SerialNumber"
                                                    Title="Equipment" Width="200px">
                                    <Template Context="certificate">
                                        <RadzenStack Gap="0.25rem">
                                            <RadzenText TextStyle="TextStyle.Body2" Class="rz-font-weight-bold">
                                                @certificate.Certificate.Equipment.SerialNumber
                                            </RadzenText>
                                            <RadzenText TextStyle="TextStyle.Caption" Class="rz-color-secondary">
                                                @certificate.Certificate.Equipment.Description
                                            </RadzenText>
                                        </RadzenStack>
                                    </Template>
                                </RadzenDataGridColumn>

                                <RadzenDataGridColumn TItem="CertificateViewModel" Property="Certificate.Status"
                                                    Title="Status" Width="120px">
                                    <Template Context="certificate">
                                        <RadzenBadge Text="@certificate.Certificate.Status"
                                                   BadgeStyle="@GetStatusBadgeStyle(certificate.StatusColor)" />
                                    </Template>
                                </RadzenDataGridColumn>

                                <RadzenDataGridColumn TItem="CertificateViewModel" Property="Certificate.IssueDate"
                                                    Title="Issue Date" Width="120px" FormatString="{0:yyyy-MM-dd}" />

                                <RadzenDataGridColumn TItem="CertificateViewModel" Property="Certificate.NextCalibrationDate"
                                                    Title="Next Due" Width="120px">
                                    <Template Context="certificate">
                                        @if (certificate.Certificate.NextCalibrationDate.HasValue)
                                        {
                                            <RadzenStack Gap="0.25rem">
                                                <RadzenText TextStyle="TextStyle.Body2"
                                                          Class="@(certificate.IsOverdue ? "rz-color-danger" : certificate.IsExpiringSoon ? "rz-color-warning" : "")">
                                                    @certificate.Certificate.NextCalibrationDate.Value.ToString("yyyy-MM-dd")
                                                </RadzenText>
                                                @if (certificate.DaysUntilNextCalibration.HasValue)
                                                {
                                                    <RadzenText TextStyle="TextStyle.Caption"
                                                              Class="@(certificate.IsOverdue ? "rz-color-danger" : certificate.IsExpiringSoon ? "rz-color-warning" : "rz-color-secondary")">
                                                        @(certificate.DaysUntilNextCalibration.Value < 0 ? $"{Math.Abs(certificate.DaysUntilNextCalibration.Value)} days overdue" : $"{certificate.DaysUntilNextCalibration.Value} days")
                                                    </RadzenText>
                                                }
                                            </RadzenStack>
                                        }
                                        else
                                        {
                                            <RadzenText TextStyle="TextStyle.Body2" Class="rz-color-secondary">N/A</RadzenText>
                                        }
                                    </Template>
                                </RadzenDataGridColumn>

                                <RadzenDataGridColumn TItem="CertificateViewModel" Property="Certificate.IsCompliant"
                                                    Title="Compliance" Width="100px">
                                    <Template Context="certificate">
                                        <RadzenIcon Icon="@(certificate.Certificate.IsCompliant ? "check_circle" : "error")"
                                                  Style="@($"color: {(certificate.Certificate.IsCompliant ? "var(--rz-success)" : "var(--rz-danger)")}")" />
                                    </Template>
                                </RadzenDataGridColumn>

                                <RadzenDataGridColumn TItem="CertificateViewModel" Title="Actions" Width="120px" Sortable="false" Filterable="false">
                                    <Template Context="certificate">
                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                                            <RadzenButton Icon="visibility" Size="ButtonSize.Small" Variant="Variant.Text"
                                                        Click="@(() => ViewCertificate(certificate.Certificate.Id))"
                                                        Title="View Details" />
                                            <RadzenButton Icon="download" Size="ButtonSize.Small" Variant="Variant.Text"
                                                        Click="@(() => DownloadCertificate(certificate.Certificate.Id))"
                                                        Disabled="@(!certificate.CanDownload)"
                                                        IsBusy="@certificate.IsDownloading"
                                                        Title="Download PDF" />
                                        </RadzenStack>
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>

                        <!-- Pagination -->
                        @if (ViewModel.SearchResponse.TotalPages > 1)
                        {
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenText TextStyle="TextStyle.Body2" Class="rz-color-secondary">
                                    Showing @((ViewModel.SearchRequest.Page - 1) * ViewModel.SearchRequest.PageSize + 1) 
                                    to @(Math.Min(ViewModel.SearchRequest.Page * ViewModel.SearchRequest.PageSize, ViewModel.SearchResponse.TotalCount)) 
                                    of @ViewModel.SearchResponse.TotalCount certificates
                                </RadzenText>

                                <RadzenPager Count="@ViewModel.SearchResponse.TotalCount" 
                                           PageSize="@ViewModel.SearchRequest.PageSize" 
                                           PageNumbersCount="5" 
                                           PageChanged="@OnPageChanged" />
                            </RadzenStack>
                        }
                    }
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

@code {
    private CertificateSearchViewModel ViewModel = new();
    private RadzenDataGrid<CertificateViewModel>? certificatesGrid;
    private string _activeQuickFilter = "";

    private readonly List<int> _pageSizeOptions = new() { 10, 25, 50, 100 };
    private readonly List<object> _complianceOptions = new()
    {
        new { Text = "Compliant", Value = (bool?)true },
        new { Text = "Non-Compliant", Value = (bool?)false }
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadFilterOptions();
            await PerformSearch();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing certificate search page");
            ViewModel.SearchError = "Failed to load certificate search page. Please try again.";
        }
    }

    private async Task LoadFilterOptions()
    {
        try
        {
            // TODO: Get customer ID from authentication context
            var customerId = 1; // Placeholder

            var filterOptions = await CertificateService.GetFilterOptionsAsync(customerId);

            ViewModel.AvailableEquipmentTypes = filterOptions.EquipmentTypes;
            ViewModel.AvailableManufacturers = filterOptions.Manufacturers;
            ViewModel.AvailableTechnicians = filterOptions.Technicians;
            ViewModel.AvailableLaboratories = filterOptions.Laboratories;
            ViewModel.AvailableLocations = filterOptions.Locations;
            ViewModel.AvailableDepartments = filterOptions.Departments;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading filter options");
        }
    }

    private async Task PerformSearch()
    {
        try
        {
            ViewModel.IsSearching = true;
            ViewModel.SearchError = null;
            StateHasChanged();

            // TODO: Get customer ID from authentication context
            var customerId = 1; // Placeholder

            var response = await CertificateService.SearchCertificatesAsync(
                ViewModel.SearchRequest, customerId);

            ViewModel.SearchResponse = response;
            ViewModel.Certificates = response.Certificates.Select(c => new CertificateViewModel { Certificate = c }).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error performing certificate search");
            ViewModel.SearchError = "Search failed. Please try again.";
        }
        finally
        {
            ViewModel.IsSearching = false;
            StateHasChanged();
        }
    }

    private async Task RefreshSearch()
    {
        await PerformSearch();
    }

    private void ApplyQuickFilter(string filterType)
    {
        _activeQuickFilter = filterType;
        ViewModel.ApplyQuickFilter(filterType);
        _ = PerformSearch();
    }

    private void ToggleAdvancedFilters()
    {
        ViewModel.ShowAdvancedFilters = !ViewModel.ShowAdvancedFilters;
    }

    private void ClearFilters()
    {
        _activeQuickFilter = "";
        ViewModel.ResetFilters();
        _ = PerformSearch();
    }

    private async Task OnPageChanged(PagerEventArgs args)
    {
        ViewModel.SearchRequest.Page = args.PageIndex + 1;
        await PerformSearch();
    }

    private async Task OnPageSizeChanged()
    {
        ViewModel.SearchRequest.Page = 1;
        await PerformSearch();
    }

    private void ToggleSelectAll()
    {
        ViewModel.ToggleSelectAll();
        StateHasChanged();
    }

    private void OnSelectionChanged(CertificateViewModel certificate, bool value)
    {
        certificate.IsSelected = value;
        StateHasChanged();
    }

    private void ClearSelection()
    {
        ViewModel.ClearSelection();
        StateHasChanged();
    }

    private async Task ViewCertificate(int certificateId)
    {
        // TODO: Navigate to certificate detail page
        await JSRuntime.InvokeVoidAsync("open", $"/certificates/{certificateId}", "_blank");
    }

    private async Task DownloadCertificate(int certificateId)
    {
        try
        {
            var certificate = ViewModel.Certificates.FirstOrDefault(c => c.Certificate.Id == certificateId);
            if (certificate == null) return;

            certificate.IsDownloading = true;
            StateHasChanged();

            // TODO: Get customer ID from authentication context
            var customerId = 1; // Placeholder

            var result = await CertificateService.DownloadCertificateAsync(certificateId, customerId);

            if (result.Success && result.FileData != null)
            {
                await JSRuntime.InvokeVoidAsync("downloadFile",
                    result.FileName,
                    result.ContentType,
                    Convert.ToBase64String(result.FileData));
            }
            else
            {
                certificate.DownloadError = result.ErrorMessage ?? "Download failed";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error downloading certificate {CertificateId}", certificateId);
            var certificate = ViewModel.Certificates.FirstOrDefault(c => c.Certificate.Id == certificateId);
            if (certificate != null)
            {
                certificate.DownloadError = "Download failed. Please try again.";
            }
        }
        finally
        {
            var certificate = ViewModel.Certificates.FirstOrDefault(c => c.Certificate.Id == certificateId);
            if (certificate != null)
            {
                certificate.IsDownloading = false;
                StateHasChanged();
            }
        }
    }

    private async Task DownloadSelected()
    {
        try
        {
            var selectedIds = ViewModel.GetSelectedCertificateIds();
            if (!selectedIds.Any()) return;

            // TODO: Get customer ID from authentication context
            var customerId = 1; // Placeholder

            var result = await CertificateService.DownloadMultipleCertificatesAsync(selectedIds, customerId);

            if (result.Success && result.FileData != null)
            {
                await JSRuntime.InvokeVoidAsync("downloadFile",
                    result.FileName,
                    result.ContentType,
                    Convert.ToBase64String(result.FileData));
            }
            else
            {
                ViewModel.SearchError = result.ErrorMessage ?? "Bulk download failed";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error downloading selected certificates");
            ViewModel.SearchError = "Bulk download failed. Please try again.";
        }
    }

    private async Task ExportResults()
    {
        try
        {
            // TODO: Implement export functionality
            await JSRuntime.InvokeVoidAsync("alert", "Export functionality coming soon!");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error exporting results");
        }
    }

    private BadgeStyle GetStatusBadgeStyle(string statusColor)
    {
        return statusColor switch
        {
            "success" => BadgeStyle.Success,
            "warning" => BadgeStyle.Warning,
            "danger" => BadgeStyle.Danger,
            "info" => BadgeStyle.Info,
            "secondary" => BadgeStyle.Secondary,
            "light" => BadgeStyle.Light,
            _ => BadgeStyle.Secondary
        };
    }
}
