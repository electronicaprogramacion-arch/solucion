@namespace Blazed.Controls

@if (ResolvedType != null)
{
    <DynamicComponent Type="@ResolvedType" Parameters="@BuildParameters()" />
}
else
{
    <div class="error-component">
        <p>Component not found: @ComponentName</p>
    </div>
}

@code {
    [Parameter] public string? ComponentName { get; set; }
    [Parameter] public Type? ComponentType { get; set; }
    [Parameter] public string? AssemblyName { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public RenderFragment? Header { get; set; }
    [Parameter] public RenderFragment? Footer { get; set; }
    [Parameter] public RenderFragment<object>? ItemTemplate { get; set; }
    [Parameter] public IDictionary<string, object>? Parameters { get; set; }
    [Parameter(CaptureUnmatchedValues = true)] public IDictionary<string, object>? AdditionalAttributes { get; set; }

    private Type? ResolvedType
    {
        get
        {
            if (ComponentType != null)
                return ComponentType;

            if (!string.IsNullOrEmpty(ComponentName))
            {
                // Buscar en el assembly especificado
                if (!string.IsNullOrEmpty(AssemblyName))
                {
                    return Helpers.NumericExtensions.GetType($"{AssemblyName}.{ComponentName}", AssemblyName);
                }
                
                // Buscar en todos los assemblies cargados
                return Type.GetType(ComponentName) ?? 
                       AppDomain.CurrentDomain.GetAssemblies()
                           .SelectMany(a => a.GetTypes())
                           .FirstOrDefault(t => t.Name == ComponentName || t.FullName == ComponentName);
            }

            return null;
        }
    }

    private IDictionary<string, object> BuildParameters()
    {
        var parameters = new Dictionary<string, object>();

        // Agregar RenderFragments
        if (ChildContent != null)
            parameters["ChildContent"] = ChildContent;
        
        if (Header != null)
            parameters["Header"] = Header;
            
        if (Footer != null)
            parameters["Footer"] = Footer;
            
        if (ItemTemplate != null)
            parameters["ItemTemplate"] = ItemTemplate;

        // Agregar par√°metros personalizados
        if (Parameters != null)
        {
            foreach (var param in Parameters)
            {
                parameters[param.Key] = param.Value;
            }
        }

        // Agregar atributos adicionales
        if (AdditionalAttributes != null)
        {
            foreach (var attr in AdditionalAttributes)
            {
                parameters[attr.Key] = attr.Value;
            }
        }

        return parameters;
    }
}