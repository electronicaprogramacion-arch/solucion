@namespace Blazed.Controls
@typeparam TValue
@using BlazorApp1.Client.Security
@using Blazored.Modal
@using Blazored.Modal.Services
@using Helpers.Controls
@using Helpers
@using Newtonsoft.Json;
@inherits Blazed.Controls.TextInputBase<TValue>



@if(ViewProperty != null )

{


    Label = ViewProperty.Display;
    if (ViewProperty.IsDisabled.HasValue)
    {
        IsDisabled = ViewProperty.IsDisabled.Value;
    }

    Type = ViewProperty.ControlType;

    ShowControl = ViewProperty.ShowControl;

    ShowLabel = ViewProperty.ShowLabel;

    if (!string.IsNullOrEmpty(ViewProperty.CSSClass))
    {
        CSSClass = ViewProperty.CSSClass;
    }

    if (ViewProperty.Min.HasValue)
    {
        Min = ViewProperty.Min.Value;
    }

    if (ViewProperty.Max.HasValue)
    {
        Max = ViewProperty.Max.Value;

    }




    if (ViewProperty.DecimalRoundType.HasValue)
    {
        DecimalRoundType = (RoundType)ViewProperty.DecimalRoundType.Value;
    }


    if (ViewProperty.DecimalNumbers.HasValue )
    {
        DecimalNumbers = ViewProperty.DecimalNumbers.Value;
    }


    if (!string.IsNullOrEmpty(ViewProperty.StepResol))
    {
        StepResol = ViewProperty.StepResol;
    }




    if (!string.IsNullOrEmpty(ViewProperty.LabelCSS))
    {
        LabelCSS = ViewProperty.LabelCSS;
    }


    EnableToastMessage = ViewProperty.EnableToastMessage;

    if (!string.IsNullOrEmpty(ViewProperty.ToastMessage))
    {
        ToastMessage = ViewProperty.ToastMessage;
    }


    ChangeBackground = ViewProperty.ChangeBackground;

    ShowDefaultOption = ViewProperty.SelectShowDefaultOption;

    IsHeader = ViewProperty.HasHeader;

    if (ViewProperty.IsVisible.HasValue && ViewProperty.IsVisible.Value)
    {
        ShowControl = true;
        @*ShowLabel = true;*@
    }
    @*else if (ViewProperty.IsVisible.HasValue && !ViewProperty.IsVisible.Value)
    {
        ShowControl = false;
        ShowLabel = false;
    }*@



    @if (OnlyHeader)
    {

        ShowControl = false;
        ShowLabel = true;

        IsHeader = true;


    }

    if (OnlyHeader && Type == "radio")
    {
        Type = "text";
    }


    if (!IsHeader && OnlyHeader)
    {
        OnlyHeader = false;
        ShowControl = false;
        ShowLabel = true;
    }


    if(string.IsNullOrEmpty(StepResol))
    {
        StepResol = "any";
    }

    //inputinvalid


    if (ViewProperty.IsValid.HasValue && !ViewProperty.IsValid.Value)
    {
        //CSSClass = CSSClass + "  warningcolor";

        if (!string.IsNullOrEmpty(ViewProperty.ErrorMesage))
        {
            ErrorMessage = ViewProperty.ErrorMesage;
        }

    }
    else 
    {
        //CSSClass = CSSClass.Replace("warningcolor", "");

        if (!string.IsNullOrEmpty(ViewProperty.ErrorMesage))
        {
            ErrorMessage = "";
        }

    }

    if (!string.IsNullOrEmpty(ViewProperty.SelectOptions) || !string.IsNullOrEmpty(ViewProperty.SelectOptionsTmP))
    {
        if (Options != null)
        {
            Options.Clear();
        }

    }

    ///////////////////////////////////////////////////////////
    @* if (!string.IsNullOrEmpty(ViewProperty.SelectOptions))
    {
        //Options = JsonConvert.DeserializeObject<Dictionary<string, string>>(ViewProperty.SelectOptions);
        //Console.WriteLine("textinput : " + ViewProperty.SelectOptions + " " + GroupName);
        var errors = new List<string>();
        Options = JsonConvert.DeserializeObject<Dictionary<string, string>>(ViewProperty.SelectOptions, new JsonSerializerSettings()
                    {
                        Error = (sender, error) =>
                        {
                            errors.Add(error.ErrorContext.Error.Message);
                            error.ErrorContext.Handled = true;

                            //Console.WriteLine("Select error " + error.ErrorContext.Error.Message);


                        }//error.ErrorContext.Handled = true

                    });

        if(errors.Count > 0)
        {
            Options = new Dictionary<string, string>();

            Options.Add("-1", "Error in Json");
        }
    } *@


    if (!string.IsNullOrEmpty(ViewProperty.SelectOptions))
    {
        //Options = JsonConvert.DeserializeObject<Dictionary<string, string>>(ViewProperty.SelectOptions);
        //Console.WriteLine("textinput: tmp" + ViewProperty.SelectOptions + " " + GroupName + " SelectFilter: " + SelectFilter);
        var errors = new List<string>();
        Options = JsonConvert.DeserializeObject<Dictionary<string, string>>(GetOptions(ViewProperty.SelectOptions,SelectFilter), new JsonSerializerSettings()
        {
            Error = (sender, error) =>
            {
                errors.Add(error.ErrorContext.Error.Message);
                error.ErrorContext.Handled = true;

                //Console.WriteLine("SelectTmp error " + error.ErrorContext.Error.Message);


            }//error.ErrorContext.Handled = true

        });

        if (errors.Count > 0)
        {
            Options = new Dictionary<string, string>();

            Options.Add("-1", "Error in Json");
        }
    }


}


@if (ViewProperty == null && IsValid.HasValue && !IsValid.Value)
{
    CSSClass = CSSClass + "  warningcolor";
    if (string.IsNullOrEmpty(ErrorMessage))
    {
        ErrorMessage = "Out of Tolerance";
    }


}
else if (ViewProperty == null)
{
    CSSClass = CSSClass.Replace("warningcolor", "");
    ErrorMessage = "";

}

@if (Label == "Class")
{
    var mess = "in";
}

@if (!string.IsNullOrEmpty(ToastMessageForce) && !string.IsNullOrWhiteSpace(Label) && (Label == "Class" || Label == "Result As Found" ))
{
    ErrorMessage = "Class mismatch";
    // ShowToast(ValidateValueMessage, Blazed.Controls.Toast.ToastLevel.Error).ConfigureAwait(false).GetAwaiter().GetResult();
}
else if (!string.IsNullOrEmpty(ToastMessageForce) && !string.IsNullOrWhiteSpace(Label) &&  (Label != "Humidity") && (ToastMessageForce.Contains("Out")))
{
    ErrorMessage = "Out of Tolerance";

}

@if (!string.IsNullOrEmpty(MessageForceDifference) && MessageForceDifference.Contains("Difference"))
{
    ErrorMessage = "Difference higher than 1%";
}


@if (string.IsNullOrEmpty(Type) && ChildContent == null)
{
    Type = "text";
}
else
if (string.IsNullOrEmpty(Type) && ChildContent != null)
{
    Type = "select";
}

@if (Type.ToLower().Trim() == "readonly")
{
    //Disabled = "disabled";
}


@if (string.IsNullOrEmpty(Id))
{
    Id = Guid.NewGuid().ToString();
}

@if (OnlyHeader)
{
    ShowControl = false;
    ShowLabel = true;
    IsHeader = false;
}

@if (LabelDown)
{
    CSSClass = "mat-input";
    LabelCSS = "mat-label";
    DivCSS = "mat-div mat-div-sp";

}

@if (@ChildContent != null && string.IsNullOrEmpty(Type))
{

    Type = Types.select;
}




    @switch (Type.ToLower().Trim())
    {
        case Types.numberdecimallabel:


            @if (string.IsNullOrEmpty(StepResol) || StepResol == "0")
            {
                StepResol = "any";
            }

            <div class="@DivCSS" style="margin-top:0px;margin-bottom:0rem">
                @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                {
                    <label class="@LabelCSS" for="@Id">@((MarkupString)Label)</label>
                }
                @if (ShowControl)
                {
                    <input class="@CSSClass @CssClass @CssClassDecimal" id="@Id" @bind="@CurrentValue2" min="@Min.ToString()" max="@Max.ToString()"
                    @oninput="ChangeWindow" type="number" disabled="disabled" step="@StepResol"
                    @onblur:preventDefault @onclick:stopPropagation="true" @onclick:preventDefault />

                    @GetErrorMessage(ErrorMessage)

                }


            </div>
            break;

        case Types.numberdecimal:


            @if (string.IsNullOrEmpty(StepResol) || StepResol == "0")
            {
                StepResol = "any";
            }

           <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem" >
                @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                {
                   
                    <RadzenLabel Component="@Id">@((MarkupString)Label)</RadzenLabel>

                }
                @if (ShowControl)
                {
                    <input class="@CSSClass @CssClass @CssClassDecimal" id="@Id" @bind="@CurrentValue2" @ref="SelfControl" 
                    min="@Min.ToString()" max="@Max.ToString()"
                    type="number" disabled="@IsDisabled" step="@StepResol"
                    @onblur:preventDefault @onclick:stopPropagation="true" @onclick:preventDefault />

                    @GetErrorMessage(ErrorMessage)
                }

            </RadzenStack>
            break;

        case Types.number:



            @if (string.IsNullOrEmpty(StepResol) || StepResol == "0")
            {
                StepResol = "any";
            }
            
             <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem" >
                @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                {
                    <RadzenLabel Component="@Id">@((MarkupString)Label)</RadzenLabel>
                }
                @if (ShowControl)
                {
                    if (Max == 0 && Min == 0)
                    {
                        <input class="@CSSClass @CssClass" id="@Id" @bind="@CurrentValueNumber"
                        type=@Type.ToLower()
                        disabled="@IsDisabled"
                        step="@StepResol"
                        @onblur:preventDefault
                        @onclick:stopPropagation="true"
                        @onclick:preventDefault
                        />
                    }
                    else
                    {
                        <input class="@CSSClass @CssClass" id="@Id" @bind="@CurrentValueNumber" min="@Min.ToString()" max="@Max.ToString()"
                        type=@Type.ToLower()
                        disabled="@IsDisabled"
                        step="@StepResol"
                        @onblur:preventDefault
                        @onclick:stopPropagation="true"
                        @onclick:preventDefault
                        />

                    }




                    @GetErrorMessage(ErrorMessage)
                }
             
            </RadzenStack>
            break;


        case Types.PassWord:

            @*<div class="form-control-wrapper" style="margin-top:15px">@onkeypress:preventDefault*@
            <div class="form-group" style="margin-top:0px;margin-bottom:0rem">
                @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                {
                    <label class="@LabelCSS" for="@Id">@((MarkupString)Label)</label>
                }

                @if (ShowControl)
                {
                    <input class="@CSSClass @CssClass" id="@Id" @bind="@CurrentValueAsString"
                    @oninput="ChangeWindow" type=@Type.ToLower() disabled="@IsDisabled" />


                    @GetErrorMessage(ErrorMessage)
                }

            </div>
            break;


        case Types.text:

            
           @*  <div class="@DivCSS" style="margin-top:0px;margin-bottom:0rem">
                @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                {
                    <label class="@LabelCSS" for="@Id">@((MarkupString)Label)</label>
                }
                @if (ShowControl)
                {
                    <input class="@CSSClass @CssClass" id="@Id" @bind="@CurrentValueAsString"
                    @oninput="ChangeWindow" type=@Type.ToLower() disabled="@IsDisabled" />
                    @GetErrorMessage(ErrorMessage)
                }

            </div> *@

           <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                {
                    
                    <RadzenLabel Component="@Id">@((MarkupString)Label)</RadzenLabel>


                }
                @if (ShowControl)
                {
                    <input class="@CSSClass @CssClass" id="@Id" @bind="@CurrentValueAsString"
                           @oninput="ChangeWindow" type=@Type.ToLower() disabled="@IsDisabled" />
                    @GetErrorMessage(ErrorMessage)
                }

            </RadzenStack>


            break;

        case Types.Switch:


            if (IsRowView)
            {
                Style = "top: 0rem";
            }


         @*    <div class="rz-p-12 rz-text-align-center">
    <RadzenCheckBox TValue="bool" Value=@value Change=@(args => value = args) Name="CheckBox2" />
    <RadzenLabel Text="CheckBox" Component="CheckBox2" class="rz-ms-2" />
</div> *@

        if (Model == null)
        {

               

                <div class="custom-control custom-switch" style="@Style">
                    @if (ShowControl)
                    {
                        <input type="checkbox" class="custom-control-input @CssClass" id="@Id" @oninput="ChangeWindow"
                        disabled="@IsDisabled" @bind="@CurrentValue">

                    @* <RadzenCheckBox TValue="bool" Value=@resp Change=@(args => value = args) Name="CheckBox2" /> *@

                    }
                    @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                    {
                        @* <label class="custom-control-label" for="@Id">@((MarkupString)Label)</label> *@
                    <RadzenLabel Component="@Id" class="custom-control-label">@((MarkupString)Label)</RadzenLabel>
                    }
                    else
                    {
                    <RadzenLabel Component="@Id" class="custom-control-label"></RadzenLabel>
                    }
                </div>
            }
            else
            {
           

                <div class="custom-control custom-switch">
                    @if (ShowControl)
                    {
                        <input type="checkbox" class="custom-control-input @CssClass" id="@Id" @oninput="ChangeObject"
                        disabled="@IsDisabled" @bind="@CurrentValue">

                    @* <RadzenCheckBox TValue="bool" Value=@resp Change=@(args => value = args) Name="@id" /> *@

                    }
                    @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                    {
                        <label class="custom-control-label" for="@Id">@((MarkupString)Label)</label>
                    }
                    else
                    {
                        <label class="custom-control-label" for="@Id"></label>
                    }
                </div>

            }
            break;


        case Types.ReadOnlySwitch:


            <div class="custom-control custom-switch">
                <input type="checkbox" class="custom-control-input @CssClass" id="@Id" disabled value="@CurrentValueAsString">
                @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                {
                    <label class="custom-control-label" for="customSwitch2">@Label</label>
                }
            </div>

            break;


        case Types.checkbox:
            <input class="form-check-input
               @CssClass" type="checkbox" id="@Id"
            @oninput="ChangeWindow"
            value="@CurrentValueAsString">
            break;


        case Types.ReadOnlyText:
            <div class="@DivCSS" style="margin-top:0px;margin-bottom:0rem">

                @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                {
                    <label class="@LabelCSS" for="@Id">@((MarkupString)Label)</label>
                }
                @if (ShowControl)
                {
                    <label class="@CSSClass @CssClass">@CurrentValueAsString</label>

                    @GetErrorMessage(ErrorMessage)
                }
            </div>
            break;


        case Types.label:

            <label class="@CssClass">@CurrentValueAsString</label>

            break;


        case Types.select:

            <div class="form-control-wrapper">
                @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                {
                    <label class="@LabelCSS" for="@Id">@((MarkupString)Label)</label>
                }
                @if (ShowControl)
                {
                    @*  <select class="@CSSClass @CssClass" id="@Id" @onchange="DoStuff" @bind="CurrentValueAsString" disabled="@IsDisabled" @oninput="ChangeWindow"> *@
                    <select class="@CSSClass @CssClass" value="@CurrentValueAsString" @onchange="@(async arg => await DoStuff(arg))">

                        @if (ShowDefaultOption)
                        {
                            <option value="0" selected>- Please Select -</option>
                        }

                        @if (ChildContent == null && Options != null && Options.Count > 0)
                        {
                            var cont = 0;
                            foreach (var item in Options)
                            {


                                if (CurrentValueAsString == item.Key || (CurrentValueAsString == "0" && cont == 0))
                                {
                                    <option value="@item.Key" selected>@item.Value</option>
                                }
                                else
                                {
                                    <option value="@item.Key">@item.Value</option>
                                }


                                cont++;

                            }
                        }
                        else
            if (ChildContent != null)
                        {
                            @ChildContent
                        }

                    </select>

                    @GetErrorMessage(ErrorMessage)
                }
            
            </div>

            break;

        case Types.ReadOnlySelect:

            <div class="form-control-wrapper">
                @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                {
                    <label class="@LabelCSS" for="@Id">@((MarkupString)Label)</label>
                }
                @if (ShowControl)
                {
                    <select class="form-control @CssClass" id="@Id" @bind="CurrentValueAsString" disabled>
                        @if (ShowDefaultOption)
                        {
                            <option value="0" selected>- Please Select -</option>
                        }
                        @ChildContent
                    </select>
                    @GetErrorMessage(ErrorMessage)

                }
            </div>
            break;

        case Types.datetime:

            <div class="@DivCSS">
                @if (!IsDisabled)
                {

                    @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                    {
                        <label class="@LabelCSS" for="@Id">@((MarkupString)Label)</label>
                    }

                    @if (OnChangeObjectControl.HasDelegate && ShowControl)
                    {
                        <InputDate @bind-Value="@CurrentValue" @oninput="ChangeObject" @bind-Value:culture="en-US" class="form-control" @bind-Value:format="MM/dd/yyyy">
                        </InputDate>
                    }
                    else if (ShowControl)
                    {
                        <InputDate @bind-Value="@CurrentValue" @bind-Value:culture="en-US" @oninput="ChangeObject" class="form-control" @bind-Value:format="MM/dd/yyyy">
                        </InputDate>
                    }

                    @GetErrorMessage(ErrorMessage)

                }
                else
                {
                    @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                    {
                        <label class="@LabelCSS" for="@Id">@((MarkupString)Label)</label>
                    }

                    @if (ShowControl)
                    {
                        <InputDate @bind-Value="@CurrentValue" disabled="disabled" @bind-Value:culture="en-US" class="form-control" @bind-Value:format="MM/dd/yyyy">
                        </InputDate>
                    }

                }




            </div>
            break;

        case Types.TextArea:
            <div class="form-control-wrapper">
                @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                {
                    <label class="@LabelCSS" for="@Id">@((MarkupString)Label)</label>
                }
                @if (ShowControl)
                {
                    <textarea class="@CSSClass @CssClass" id="@Id" @bind="@CurrentValueAsString" @oninput="ChangeWindow" disabled="@IsDisabled" />
                    @GetErrorMessage(ErrorMessage)
                }
            </div>
            break;


        case Types.ReadOnlyTextArea:
            <div class="@DivCSS">
                @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                {
                    <label class="@LabelCSS" for="@Id">@((MarkupString)Label)</label>
                }
                @if (ShowControl)
                {
                    <textarea class="@CSSClass @CssClass" id="@Id" @bind="@CurrentValueAsString" disabled />
                    @GetErrorMessage(ErrorMessage)
                }
            </div>
            break;


        case Types.NotBindigText:
            <div class="@DivCSS">
                @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                {
                    <label class="@LabelCSS" for="@Id">@((MarkupString)Label)</label>
                }
                @if (ShowControl)
                {
                    <input class="@CSSClass @CssClass" id="@Id" @oninput="ChangeWindow" />
                }
            </div>
            break;


        case Types.Button:

            <div class="@DivCSS" style="margin-top:0px;margin-bottom:0rem">
                @if (string.IsNullOrWhiteSpace(ViewProperty.Display))
                {
                    ViewProperty.Display = "";
                }

                <input class="@CSSClass @CssClass" id="@Id" @bind="@CurrentValueModal"
                type=@ViewProperty.ControlType disabled="@ViewProperty.IsDisabled" style="display:none" />

                @{
                    //Console.WriteLine("antes de");
                }

                <SearchButtonComponent FormType="@FormType"
                Type="@TypeButton"
                Size="@FormSize"
                Text="@ViewProperty.Display"
                IsDisabled="@IsDisabled"
                ModalResult="@modalresult">

                </SearchButtonComponent>
                @GetErrorMessage(ViewProperty.ErrorMesage)

            </div>
            break;

        case Types.Link:
            <div class="@DivCSS">
                @if (!string.IsNullOrWhiteSpace(Label) &&  ShowLabel)
                {
                    <label class="@LabelCSS" for="@Id">@((MarkupString)Label)</label>
                }
                else if(!IsRowView)
                {
                    <div class="form-control-label" style="top: 50px;height: 1.5em;"></div>
                }
                else if (IsRowView)
                {
                    <div class="form-control-label" ></div>
                }

                @if (ShowControl)
                {
                    <a class="@CSSClass @CssClass" id="@Id" href="@CurrentValueAsString" disabled="@IsDisabled" target="_blank">
                        @if (!string.IsNullOrWhiteSpace(Label))
                        {
                            <label class="@LabelCSS" for="@Id">@((MarkupString)Label)</label>
                        }
                        else
                        {
                            <label class="@LabelCSS" for="@Id">@CurrentValueAsString</label>
                        }
                    </a>
                }
            </div>

            break;


        case Types.Coordinates:


            <div class="@DivCSS">
                @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                {
                    <label class="@LabelCSS" for="@Id">@((MarkupString)Label)</label>
                }
                @if (ShowControl)
                {
                    <div class=" input-group" id="@("div" + Id)">

                        <input type="number" class="grados" disabled="@IsDisabled" style="width:50px;"  data-indice="@Id" min="0" max="360" step="1" @onblur:preventDefault
                        @onclick:stopPropagation="true"
                        @onclick:preventDefault>
                        <label for="grados">°</label>
                        <input type="number" class="minutos" disabled="@IsDisabled" style="width:50px;" data-indice="@Id" min="0" max="60" step="1" @onblur:preventDefault
                        @onclick:stopPropagation="true"
                        @onclick:preventDefault>
                        <label for="grados">'</label>
                        <input type="number" class="segundos" disabled="@IsDisabled" style="width:70px" data-indice="@Id" min="0" step="any" @onblur:preventDefault
                        @onclick:stopPropagation="true"
                        @onclick:preventDefault>
                        <label for="grados">"</label>
                        @*<input type="number" style="width:40px" class="valorDecimal"  data-indice="@Id" step="any">*@

                        <input id="@Id" @ref="myTextInput" @bind="@CurrentValueAsString" width="@(CurrentValueAsString + "px")"
                        type="number"
                        disabled="@IsDisabled"
                        style="width:1px;display:none"
                        class="valorDecimal"
                        data-indice="@Id" step="any"

                        @onblur:preventDefault
                        @onclick:stopPropagation="true"
                        @onclick:preventDefault />
                        <button class="buttonvalorDecimal" style="width:40px;display:none" id="@Id" data-indice="@Id" @onclick="@(async () => await GetSelectionStart(myTextInput))" @onblur:preventDefault
                        @onclick:stopPropagation="true"
                        @onclick:preventDefault>
                            Get
                        </button>
                    </div>
                    @GetErrorMessage(ErrorMessage)


                }
            </div>




            break;


        case Types.Radio:


            if (IsRowView)
            {
                Style = "top: 0rem";
            }

            if (Model == null)
            {
                <div class="custom-control custom-radio" style="@Style">
                    @if (ShowControl)
                    {
                        <input @attributes="AdditionalAttributes" type="radio" name="options" class="custom-control-input @CssClass" id="@Id"
                        @bind="CurrentValueAsString" @bind:event="onchange" @bind:after="PerformSearch" checked="@(IsChecked(Value))"
                        disabled="@IsDisabled" >
                    }
                    @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                    {
                        <label class="custom-control-label" for="@Id">@((MarkupString)Label)</label>
                    }
                    else
                    {
                        <label class="custom-control-label" for="@Id"></label>
                    }
                </div>
            }
            else
            {
                <div class="custom-control custom-radio">
                    @if (ShowControl)
                    {

                        <input @attributes="AdditionalAttributes" type="radio" name="options" class="custom-control-input @CssClass" id="@Id"
                        @bind="CurrentValueAsString" @bind:event="onchange" @bind:after="PerformSearch" checked="@(IsChecked(Value))"
                        disabled="@IsDisabled">


                    }
                    @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                    {
                        <label class="custom-control-label" for="@Id">@((MarkupString)Label)</label>
                    }
                    else
                    {
                        <label class="custom-control-label" for="@Id"></label>
                    }
                </div>

            }
            break;    
            
        case Types.Handler:


            <div class="@DivCSS" style="display: flex; align-items: center; gap: 10px; margin-top:0px; margin-bottom:0rem;">

                <div class="row">


                </div>
                <button class="d-sm-inline-block btn btn-sm btn-primary shadow-sm"
                @onclick="@(()=> ShowModal(CurrentValueAsString))"
                @onclick:stopPropagation @onclick:preventDefault>
                    Tolerance
                </button>

                <input class="@CSSClass @CssClass" id="@Id" @bind="@CurrentValueAsString"
                @oninput="ChangeWindow" type=@Type.ToLower() disabled="@IsDisabled" style="display:none" />
                @GetErrorMessage(ErrorMessage)


                @if (!string.IsNullOrEmpty(@CurrentValueAsString))
                {
                    @*  <div class="d-sm-inline-block btn btn-sm btn-danger shadow-sm editButton" style="margin-top:0px;margin-bottom:0rem"> *@

                    <button class="d-sm-inline-block btn btn-sm btn-danger shadow-sm"
                    @onclick="@(()=> DeleteTolerance())"
                    @onclick:stopPropagation @onclick:preventDefault>
                        Delete Tolerance
                    </button>

                    @*   </div> *@
                }

            </div>
            break;

        case Types.Search:
            <div class="@DivCSS" style="margin-top:0px; margin-bottom:0rem;">
                @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                {
                    <label class="@LabelCSS" for="@Id">@((MarkupString)Label)</label>
                }

                <input type="text"
                class="@CSSClass @CssClass" id="@Id" @bind="@CurrentValueAsString"
                placeholder="Select"
                disabled="@IsDisabled"
                @onclick="@(() => SearchDynamicModal(Component))"
                @onclick:stopPropagation
                @onclick:preventDefault
                @oninput="ChangeWindow"
                />

                @*    <input class="@CSSClass @CssClass" id="@Id" @bind="@CurrentValueAsString"
                @oninput="ChangeWindow" type=@Type.ToLower() disabled="false" /> *@
                @GetErrorMessage(ErrorMessage)




            </div>
            break;

        case Types.SearchFiltered:
            <div class="@DivCSS" style="margin-top:0px; margin-bottom:0rem;">
                @if (!string.IsNullOrWhiteSpace(Label) && ShowLabel)
                {
                    <label class="@LabelCSS" for="@Id">@((MarkupString)Label)</label>
                }
                @if (!string.IsNullOrEmpty(newValueFiltered))
                {
                    var IdOld = newValueFiltered.Contains("-") ? newValueFiltered.Split('-')[0] : "0";
                    var IdNew = CurrentValueAsString.Contains("-") ? CurrentValueAsString.Split('-')[0] : "0"; 

                    @if (IdOld != "0" && IdNew != "0" && @IdOld != @IdNew )
                    {
                        CurrentValueAsString = IdNew;
                        newValueFiltered = null;
                    }
                }

                @if (!string.IsNullOrEmpty(CurrentValueAsString) && newValueFiltered != CurrentValueAsString && CurrentValueAsString != "0")
                {
                    //CurrentValueAsString = newValueFiltered;
                    newValueFiltered = CurrentValueAsString;

                    @*  CurrentValueAsString.Contains("-") && CurrentValueAsString.IndexOf("-") < CurrentValueAsString.Length - 1
                    ? CurrentValueAsString.Substring(CurrentValueAsString.IndexOf("-") + 1)
                    : ""; *@

                } 

                <input type="hidden"
                class="@CSSClass @CssClass" id="@Id" @bind="@CurrentValueAsString"
                placeholder="Hide"
                disabled="@IsDisabled"
                @oninput="ChangeWindow" />

                <input type="text"
                class="@CSSClass @CssClass" id="@Id" @bind="@newValueFiltered"
                placeholder="Select"
                disabled="@IsDisabled"
                @onclick="@(() => SearchDynamicModalFiltered())"
                @onclick:stopPropagation
                @onclick:preventDefault
                @oninput="ChangeWindow"
                />

                @GetErrorMessage(ErrorMessage)
            </div>
            break;

        case Types.Execute:

            <div class="@DivCSS"  style="padding: 3%;">

                <button class="d-sm-inline-block btn btn-sm btn-primary shadow-sm"
                @onclick="@(()=> CopyTo())"
                @onclick:stopPropagation @onclick:preventDefault>
                    Copy
                </button>

                <input class="@CSSClass @CssClass" id="@Id" @bind="@CurrentValueAsString"
                @oninput="ChangeWindow" type=@Type.ToLower() disabled="@IsDisabled" style="display:none" />
                @GetErrorMessage(ErrorMessage)


            </div>
            break;

        default:
            <div>Not implemented control, please check with your administrator</div>
            break;


    }




@code 
{
    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            JSRuntime.InvokeVoidAsync("eval", "event.preventDefault();");
        }
    }
    // OptionDisabled="@(i => int.Parse(i.Value!) > 6)"

    //YPP
     @inject IModalHandler modalHandler;

     @inject IDynamicModalHandler dynamicModalHandler;

    private string toleranceValue { get; set; } = string.Empty;
    private string newValueFiltered { get; set; } = string.Empty;

    private async Task ShowModal(string currenValue)
    {

        string jsonTolerancePerTestPoint = null;
        if (!string.IsNullOrEmpty(CurrentValueAsString) && CurrentValueAsString != "0")
        {

            jsonTolerancePerTestPoint = CurrentValueAsString;
        }


        var result = await modalHandler.ShowModalAsync(jsonTolerancePerTestPoint);
        if (!string.IsNullOrEmpty(result))
        {
            CurrentValueAsString = result;
            StateHasChanged();
        }
    }
    private async Task SearchDynamicModal(string component)
    {

        var result = await dynamicModalHandler.ShowModalAsync(component, null);

        if (!string.IsNullOrEmpty(result))
        {

            var obj = JsonConvert.DeserializeObject<Dictionary<string, object>>(result);


            string keyField = Key;
            string valueField = Val;
            var valueValue = "";

            if (obj.ContainsKey(keyField))
            {

                var keyValue = obj[keyField]?.ToString();
                if (valueField.Contains(","))
                {
                    string[] fields = valueField.Split(',')
                            .Select(f => f.Trim())
                            .ToArray();
                    foreach (var field in fields)
                    {
                        if (obj.ContainsKey(field))
                        {
                            var fieldValue = obj[field]?.ToString();
                            if (!string.IsNullOrEmpty(fieldValue))
                            {
                                if (string.IsNullOrEmpty(valueValue))
                                    valueValue = fieldValue;
                                else
                                    valueValue += ";" + fieldValue;
                            }
                        }
                    }
                }
                else
                {
                    valueValue = obj[valueField]?.ToString();
                }


                CurrentValueAsString = keyValue + "-" + valueValue;

                //Console.WriteLine($"Key: {keyValue}, Value: {valueValue}");
            }
            else
            {
                // Manejar el caso donde faltan los campos
                //Console.WriteLine("No se encontraron los campos requeridos en el resultado.");
            }

            StateHasChanged();
        }

    }

    private async Task CopyTo()
    {
        // Llamar el método SetCopyAsFoundToAsLeft() del componente padre
        if (OnCopyToClicked.HasDelegate)
        {
            try
            {
                await OnCopyToClicked.InvokeAsync();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error invoking OnCopyToClicked: {ex.Message}");
            }
        }

        StateHasChanged();
    }



    private async Task SearchDynamicModalFiltered()
    {

        string customerIdValue = null;
        if (!string.IsNullOrEmpty(CurrentValueAsString) && CurrentValueAsString != "0")
        {
            customerIdValue = CurrentValueAsString;
            CurrentValueAsString = null; // Limpiar el valor actual
        }



        if (!string.IsNullOrEmpty(customerIdValue))
        {
            try
            {
                @if (customerIdValue.Contains("-"))
                {
                    var parts = customerIdValue.Split('-');
                    if (parts.Length > 0 && int.TryParse(parts[0], out int parsedId))
                    {
                        FilterId = parsedId;
                    }
                }
                else
                {
                    FilterId = int.Parse(customerIdValue);
                }
            }
            catch (Exception ex)
            {
                //Console.WriteLine($"error in CustomerID: {ex.Message}");
            }
        }

        // Crear el JSON con el filtro del CustomerID
        string jsonData = null;
        if (FilterId.HasValue)
        {
            var filterData = new { FilterId = FilterId.Value };
            jsonData = JsonConvert.SerializeObject(filterData);
        }

        // Llamar al modal con el filtro
        var result = await dynamicModalHandler.ShowModalAsync("Contact_Search", jsonData);

        if (!string.IsNullOrEmpty(result))
        {
            var obj = JsonConvert.DeserializeObject<Dictionary<string, object>>(result);

            string keyField = Key;
            string valueField = Val;

            if (obj.ContainsKey(keyField) && obj.ContainsKey(valueField))
            {
                var keyValue = obj[keyField]?.ToString();
                var valueValue = obj[valueField]?.ToString();
                CurrentValueAsString = keyValue + " " + valueValue;
                newValueFiltered = keyValue + " " + valueValue;
               
            }
            else
            {
              
                //Console.WriteLine("Not data found");
            }

            StateHasChanged();
        }
    }


    private async Task DeleteTolerance()
    {
      
        CurrentValueAsString = null;
        StateHasChanged();

    }
    //

  
 

    public bool ToastLunch { get; set; }

    private string _currentValue2;

    private string _currentValueTemp;


    private string _CurrentValueNumber;




    public string CurrentValueNumber
    {
        get
        { 
            var item = CurrentValueAsString;

            //return item;


            if (1==1)
            {
                if (!string.IsNullOrEmpty(item))
                {
                    item = item.Replace(",", ".");
                }


                if (!string.IsNullOrEmpty(item) && item.ToString().ToLower().Contains("e-"))
                {
                    //var result1 = string.Format("{0:F5}", item); // CurrentValueAsString.ToString("N30");// String.Format("{0:N30}", CurrentValueAsString);//String.Format("{0:N30}", result1);

                    decimal h2 = Decimal.Parse(item, System.Globalization.NumberStyles.Any);

                    return h2.ToString();
                }

                return item;

            }
        }
        set
        {
            CurrentValueAsString = value;
        }

    }



    public string CurrentValue2
    {
        get
        {

            var item = CurrentValueAsString;

            //return item;

            if (IsRounded)
            {
                item = (CurrentValueAsString);
            }
            if (item != null)
            {
                item= item.Replace(",", ".");

                if (item != null && item.ToString().ToLower().Contains("e"))
                {
                    //var result1 = string.Format("{0:F5}", item); // CurrentValueAsString.ToString("N30");// String.Format("{0:N30}", CurrentValueAsString);//String.Format("{0:N30}", result1);

                    decimal h2 = Decimal.Parse(item, System.Globalization.NumberStyles.Any);

                    return h2.ToString();
                }

                return item;

            }
            else
            {
                return item;
            }


        }
        set
        {
            IsInternalRounded = true;
            var temp = value;
            if (ValidateValue.HasValue && ValidateValue.Value == false)
            {

                ShowToast(ValidateValueMessage, Blazed.Controls.Toast.ToastLevel.Error).ConfigureAwait(false).GetAwaiter().GetResult();

            }

            //Console.WriteLine("set CurrentValueAsString");
            if(temp != null)
            {
                temp = temp.Replace(",",".");
            }

            if (IsRounded)
            {
                CurrentValueAsString = RoundedFunction(temp);

                // if (CurrentValueAsString != null && CurrentValueAsString.ToString().ToLower().Contains("e"))
                // {
                //     var result1 = string.Format("{0:F5}", CurrentValueAsString); // CurrentValueAsString.ToString("N30");// String.Format("{0:N30}", CurrentValueAsString);//String.Format("{0:N30}", result1);
                //     CurrentValueAsString= result1;
                // }

            }
            else
            {
                CurrentValueAsString = temp;
            }
        }

    }



    public string RoundedFunction(string currentString)
    {

        try
        {
            //currentString = currentString.Replace(',', '.');

            if (StepResol.Contains(","))
            {
                StepResol = StepResol.Replace(",", ".");
            }


            if (StepResol == "any" || StepResol == "0" || DecimalNumbers < 0)
            {
                return currentString;
            }

            if (DecimalNumbers == 0 && StepResol != "any"  && StepResol != "0")
            {
                DecimalNumbers = NumericExtensions.CalculateDecimalNumber(Convert.ToDecimal(StepResol));
                //Console.WriteLine("Calculate decimanumber");
            }


            if (double.TryParse(currentString, NumberStyles.Number, CultureInfo.InvariantCulture, out var parsedValue))
            {



                if (DecimalRoundType == RoundType.Without)
                {
                    parsedValue = parsedValue.ToStringNoTruncate(DecimalNumbers);
                    if (TypeValue == typeof(int) && parsedValue == 0 && EnableToastMessage
                        && !string.IsNullOrEmpty(ToastMessage)
                        && _currentValueTemp == currentString)
                    {
                        ShowToast(ToastMessage, Blazed.Controls.Toast.ToastLevel.Warning).ConfigureAwait(false).GetAwaiter().GetResult();
                        _currentValueTemp = currentString;
                        WasRounded = true;
                    }
                }



                var mult = 1;
                for (int iii = 0; iii < DecimalNumbers; iii++)
                {
                    mult = mult * 10;
                }

                if (DecimalRoundType == RoundType.Ceiling)
                {
                    //int vall = (int)parsedValue * mult;


                    parsedValue = Math.Ceiling(parsedValue);
                    parsedValue = parsedValue.ToStringNoTruncate(DecimalNumbers);
                }



                if (DecimalRoundType == RoundType.Normal)
                {


                    parsedValue = Math.Round(parsedValue, DecimalNumbers);


                }

                if (DecimalRoundType == RoundType.Floor)
                {


                    parsedValue = Math.Floor(parsedValue);
                    parsedValue = parsedValue.ToStringNoTruncate(DecimalNumbers);
                }

                if (!string.IsNullOrEmpty(StepResol) && StepResol != "any" && StepResol != "0" && double.TryParse(StepResol, NumberStyles.Number, CultureInfo.InvariantCulture, out var parsedValue3))
                {

                    if (DecimalRoundType == RoundType.RoundToResolution)
                    {

                        parsedValue = Math.Round(parsedValue / parsedValue3, MidpointRounding.AwayFromZero) * parsedValue3;
                        //Math.Round((Math.Round(parsedValue / parsedValue3, MidpointRounding.AwayFromZero)) * parsedValue3),2); // 1.25
                        parsedValue = parsedValue.ToStringNoTruncate(DecimalNumbers);
                    }

                    if (EnableToastMessage && !string.IsNullOrEmpty(ToastMessage) && (Convert.ToDouble(currentString) != parsedValue) && _currentValueTemp != currentString)
                    {
                        var ms = string.Format(ToastMessage, currentString, parsedValue);

                        ShowToast(ms, Blazed.Controls.Toast.ToastLevel.Warning).ConfigureAwait(false).GetAwaiter().GetResult();

                        ToastLunch = true;

                        _currentValueTemp = currentString;

                        WasRounded = true;

                        //Console.WriteLine("showtoast");
                    }

                    var cssinvalid = parsedValue.GetInvalidClass(parsedValue3, DecimalNumbers);

                    if (ChangeBackground && !string.IsNullOrEmpty(cssinvalid))
                    {
                        CssClassDecimal = cssinvalid;
                        //in Testpoint (weight) the typed value XX was rounded to XX



                    }
                    else
                    {
                        CssClassDecimal = "";
                    }

                }


                var parsedValue2 = parsedValue.ToString();

                var position = parsedValue2.IndexOf(".");

                var lengt = 0;

                if (position > 0)
                    lengt = parsedValue2.Substring(position + 1).Length;

                var dif = DecimalNumbers - lengt;




                //if (parsedValue.IsInt())
                if (dif > 0)
                {
                    if (DecimalRoundType == RoundType.RoundToResolution)
                    {

                    }
                    var zeros = "";
                    for (int i = 0; i < dif; i++)
                    {
                        zeros = zeros + "0";
                    }
                    if (!string.IsNullOrEmpty(zeros) && position == -1)
                    {
                        parsedValue2 = parsedValue2 + "." + zeros;
                    }
                    else if (!string.IsNullOrEmpty(zeros) && position > 0)
                    {
                        parsedValue2 = parsedValue2 + zeros;

                    }

                }

                //var a = parsedValue2; //String.Format("{0:0.00}", parsedValue2);
                if (WasRounded && ChangeBackground)
                {
                    CssClassDecimal = CssClassDecimal + " warningcolor";
                }

                //currentString= parsedValue2;



                // if (parsedValue2 != null && parsedValue2.ToString().Contains("e"))
                // {
                //     var result1 = String.Format("{0:N30}", parsedValue2);//String.Format("{0:N30}", result1);
                //     return result1;
                // }

                return parsedValue2;


            }
            else
            {
                return currentString;
            }


        }
        catch (Exception ex)
        {
            //Console.WriteLine("error textinput");
            return currentString;
        }



    }

    public string RoundedFunctionGet(string currentString)
    {

        try
        {
            if (StepResol.Contains(","))
            {
                StepResol = StepResol.Replace(",", ".");
            }

            currentString = currentString.Replace(",", ".");

            //var dc = numerCalculateResolution(parsedecimal);


            if (StepResol == "any" || StepResol == "0" || DecimalNumbers < 0)
            {
                return currentString;
            }

            if (double.TryParse(currentString, NumberStyles.Number, CultureInfo.InvariantCulture, out var parsedValue))
            {



                if (DecimalRoundType == RoundType.Without)
                {
                    parsedValue = parsedValue.ToStringNoTruncate(DecimalNumbers);
                    if (TypeValue == typeof(int) && parsedValue == 0 && EnableToastMessage
                        && !string.IsNullOrEmpty(ToastMessage)
                        && _currentValueTemp == currentString)
                    {

                        _currentValueTemp = currentString;
                        WasRounded = true;
                    }
                }



                var mult = 1;
                for (int iii = 0; iii < DecimalNumbers; iii++)
                {
                    mult = mult * 10;
                }

                if (DecimalRoundType == RoundType.Ceiling)
                {
                    //int vall = (int)parsedValue * mult;


                    parsedValue = Math.Ceiling(parsedValue);
                    parsedValue = parsedValue.ToStringNoTruncate(DecimalNumbers);
                }



                if (DecimalRoundType == RoundType.Normal)
                {


                    parsedValue = Math.Round(parsedValue, DecimalNumbers);


                }

                if (DecimalRoundType == RoundType.Floor)
                {


                    parsedValue = Math.Floor(parsedValue);
                    parsedValue = parsedValue.ToStringNoTruncate(DecimalNumbers);
                }

                if (!string.IsNullOrEmpty(StepResol) && StepResol != "any" && StepResol != "0" && double.TryParse(StepResol, NumberStyles.Number, CultureInfo.InvariantCulture, out var parsedValue3))
                {

                    if (DecimalRoundType == RoundType.RoundToResolution)
                    {
                        parsedValue = (Math.Round(parsedValue / parsedValue3, MidpointRounding.AwayFromZero)) * parsedValue3; // 1.25
                        parsedValue = parsedValue.ToStringNoTruncate(DecimalNumbers);
                    }

                    if (EnableToastMessage && !string.IsNullOrEmpty(ToastMessage) && (Convert.ToDouble(currentString) != parsedValue) && _currentValueTemp != currentString)
                    {


                        _currentValueTemp = currentString;

                        WasRounded = true;

                        //Console.WriteLine("showtoast");
                    }

                    var cssinvalid = parsedValue.GetInvalidClass(parsedValue3, DecimalNumbers);

                    if (ChangeBackground && !string.IsNullOrEmpty(cssinvalid))
                    {
                        CssClassDecimal = cssinvalid;
                        //in Testpoint (weight) the typed value XX was rounded to XX



                    }
                    else
                    {
                        CssClassDecimal = "";
                    }

                }


                var parsedValue2 = parsedValue.ToString();

                var position = parsedValue2.IndexOf(".");

                var lengt = 0;

                if (position > 0)
                    lengt = parsedValue2.Substring(position + 1).Length;

                var dif = DecimalNumbers - lengt;




                //if (parsedValue.IsInt())
                if (dif > 0)
                {
                    if (DecimalRoundType == RoundType.RoundToResolution)
                    {

                    }
                    var zeros = "";
                    for (int i = 0; i < dif; i++)
                    {
                        zeros = zeros + "0";
                    }
                    if (!string.IsNullOrEmpty(zeros) && position == -1)
                    {
                        parsedValue2 = parsedValue2 + "." + zeros;
                    }
                    else if (!string.IsNullOrEmpty(zeros) && position > 0)
                    {
                        parsedValue2 = parsedValue2 + zeros;

                    }

                }

                //var a = parsedValue2; //String.Format("{0:0.00}", parsedValue2);
                if (WasRounded && ChangeBackground)
                {
                    CssClassDecimal = CssClassDecimal + " warningcolor";
                }

                //currentString= parsedValue2;

                return parsedValue2;


            }
            else
            {
                return currentString;
            }


        }
        catch (Exception ex)
        {
            //Console.WriteLine("error textinput");
            return currentString;
        }



    }

   
    private async Task SelOptionsChange(ChangeEventArgs e)
    {
        //Console.WriteLine(e.Value);
    }
   

   
  
}


